# -----------------------------------------------------------
#  SLCW  —  prod / stage / dev
#    • /api/*  → backend-контейнер
#    • /       → фронтенд-SPA (prod/stage: Docker, dev: Firebase Studio)
# -----------------------------------------------------------

############  HTTP → HTTPS  ##################################
server {
    listen 80;
    server_name slcw.dimlight.online stage.slcw.dimlight.online dev.slcw.dimlight.online;
    return 301 https://$host$request_uri;
}

############  Host → Upstream-порты  ##########################
# API-контейнеры
map $host $api_upstream {
    default                     127.0.0.1:8080;   # prod-api
    stage.slcw.dimlight.online  127.0.0.1:8081;   # stage-api
    dev.slcw.dimlight.online    127.0.0.1:8082;   # dev-api
}

# Ping service
map $host $ping_upstream {
    default                     127.0.0.1:8081;   # prod-ping (using same port as stage-api)
    stage.slcw.dimlight.online  127.0.0.1:8081;   # stage-ping
    dev.slcw.dimlight.online    127.0.0.1:8081;   # dev-ping
}

# Frontend-контейнеры (только для prod и stage)
map $host $front_upstream {
    default                     127.0.0.1:8090;   # prod-front
    stage.slcw.dimlight.online  127.0.0.1:8091;   # stage-front
}

############  DEV HTTPS-блок (Firebase Studio)  ##############
server {
    listen 443 ssl http2;
    server_name dev.slcw.dimlight.online;

    ssl_certificate     /etc/letsencrypt/live/slcw.dimlight.online/fullchain.pem;  # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/slcw.dimlight.online/privkey.pem;    # managed by Certbot

    # --- TLS / security ---
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1h;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         EECDH+AESGCM:EECDH+CHACHA20;
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security "max-age=63072000" always;

    # --- общие proxy-настройки ---
    client_max_body_size     50m;
    proxy_read_timeout       600s;
    proxy_request_buffering  off;
    proxy_buffering          off;

    # ----------  API  ---------------------------------------
    # Main API services
    location ^~ /api/ {
        proxy_pass http://$api_upstream;
        include     proxy_params;
    }

    # Ping service under /api/ping
    location ^~ /api/ping {
        proxy_pass http://$ping_upstream/ping;
        include     proxy_params;
    }

    # ----------  FRONTEND (Firebase Studio)  -----------------
    location / {
        proxy_pass https://9000-firebase-studio-1750233364664.cluster-73qgvk7hjjadkrjeyexca5ivva.cloudworkstations.dev;
        
        # Proxy headers
        proxy_set_header Host 9000-firebase-studio-1750233364664.cluster-73qgvk7hjjadkrjeyexca5ivva.cloudworkstations.dev;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Origin https://9000-firebase-studio-1750233364664.cluster-73qgvk7hjjadkrjeyexca5ivva.cloudworkstations.dev;
        proxy_set_header Referer https://9000-firebase-studio-1750233364664.cluster-73qgvk7hjjadkrjeyexca5ivva.cloudworkstations.dev/;
        proxy_redirect off;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
        
        # SSL settings
        proxy_ssl_verify off;
        
        # Allow Firebase Studio console
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        add_header X-Frame-Options "SAMEORIGIN" always;
    }
}

############  PROD/STAGE HTTPS-блок (Docker)  ###############
server {
    listen 443 ssl http2;
    server_name slcw.dimlight.online stage.slcw.dimlight.online;

    ssl_certificate     /etc/letsencrypt/live/slcw.dimlight.online/fullchain.pem;  # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/slcw.dimlight.online/privkey.pem;    # managed by Certbot

    # --- TLS / security ---
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1h;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         EECDH+AESGCM:EECDH+CHACHA20;
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security "max-age=63072000" always;

    # --- общие proxy-настройки ---
    client_max_body_size     50m;
    proxy_read_timeout       600s;
    proxy_request_buffering  off;
    proxy_buffering          off;

    # ----------  API  ---------------------------------------
    # Main API services
    location ^~ /api/ {
        proxy_pass http://$api_upstream;
        include     proxy_params;
    }

    # Ping service under /api/ping
    location ^~ /api/ping {
        proxy_pass http://$ping_upstream/ping;
        include     proxy_params;
    }

    # ----------  FRONTEND (Docker)  -------------------------
    location / {
        proxy_pass http://$front_upstream;
        include     proxy_params;
        
        # Next.js specific headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # Next.js static files
    location /_next/ {
        proxy_pass http://$front_upstream;
        include     proxy_params;
    }
}
