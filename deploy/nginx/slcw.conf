# -----------------------------------------------------------
#  SLCW  —  prod / stage / dev
#    • /api/*  → backend-контейнер
#    • /       → фронтенд-SPA
# -----------------------------------------------------------

############  HTTP → HTTPS  ##################################
server {
    listen 80;
    server_name slcw.dimlight.online stage.slcw.dimlight.online dev.slcw.dimlight.online;
    return 301 https://$host$request_uri;
}

############  Host → Upstream-порты  ##########################
# API-контейнеры
map $host $api_upstream {
    default                     127.0.0.1:8080;   # prod-api
    stage.slcw.dimlight.online  127.0.0.1:8081;   # stage-api
    dev.slcw.dimlight.online    127.0.0.1:8082;   # dev-api
}

# Frontend-контейнеры
map $host $front_upstream {
    default                     127.0.0.1:8090;   # prod-front
    stage.slcw.dimlight.online  127.0.0.1:8091;   # stage-front
    dev.slcw.dimlight.online    127.0.0.1:8092;   # dev-front
}

############  HTTPS-блок (общий)  ############################
server {
    listen 443 ssl http2;
    server_name slcw.dimlight.online stage.slcw.dimlight.online dev.slcw.dimlight.online;

    ssl_certificate     /etc/letsencrypt/live/slcw.dimlight.online/fullchain.pem;  # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/slcw.dimlight.online/privkey.pem;    # managed by Certbot

    # --- TLS / security ---
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1h;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         EECDH+AESGCM:EECDH+CHACHA20;
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security "max-age=63072000" always;

    # --- общие proxy-настройки ---
    client_max_body_size     50m;
    proxy_read_timeout       600s;
    proxy_request_buffering  off;
    proxy_buffering          off;

    # ----------  API  ---------------------------------------
    location ^~ /api/ {
        proxy_pass http://$api_upstream;
        include     proxy_params;
    }

    # ----------  FRONTEND (SPA)  ----------------------------
    location / {
        proxy_pass http://$front_upstream;
        include     proxy_params;
        try_files   $uri $uri/ /index.html;   # client-side routing
    }
}
