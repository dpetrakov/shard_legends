# TODO — готово к работе

> Задачи проработаны, приоритизированы и готовы к выполнению. Отсортированы по приоритету.

## Высокий приоритет
<!-- Критически важные задачи, блокирующие другие -->


**D-13: Разделение публичных и внутренних эндпоинтов Production Service**
**Роль:** Backend/Infrastructure Developer
**Приоритет:** Высокий  
**Статус:** [x] Выполнено

**Описание:**
В настоящий момент Production Service обслуживает все HTTP-маршруты на одном порту, что затрудняет разграничение доступа и мониторинг. Необходимо, как в Inventory Service, вынести публичные (business API) и внутренние (admin/health/metrics) эндпоинты на разные порты.

**Критерии выполнения (Definition of Done):**
- [x] Запущены ДВА HTTP-сервера: Public (`PROD_SVC_PUBLIC_PORT`) и Internal (`PROD_SVC_INTERNAL_PORT`). Отсутствие любой переменной → немедленный «fail-fast».
- [x] Public-порт обслуживает ТОЛЬКО бизнес-API под префиксом `/production` (`/production/recipes`, `/production/factory/*`) и требует JWT-аутентификацию.
- [x] Internal-порт предоставляет `/health`, `/ready`, `/metrics` (без auth), `/api/v1/internal/*` (без auth) и `/api/v1/admin/*` (JWT с ролью `admin`). Эти маршруты недоступны на Public-порте.
- [x] Docker-compose и Helm-темплейты обновлены.
- [x] Юнит-тест через `httptest` проверяет, что `/metrics` недоступен на public-порте и доступен на internal-порте.
- [x] Линтинг и существующие тесты проходят; покрытие новой логики ≥80 %.

**Файлы для изучения:**
- `services/production-service/Dockerfile`
- `deploy/dev/api-gateway/nginx.conf`
- `docs/specs/production-service.md`

---

**D-14: P-1 Исправление префикса URL (`/production`) в Production Service**
**Роль:** Backend Developer
**Приоритет:** Высокий  
**Статус:** [ ] Готов к выполнению

**Описание:**
Audit P-1 выявил несовпадение URL-префикса: API Gateway проксирует запросы с путём `/production/*`, тогда как сервис монтирует роуты под `/api/v1`. Требуется унифицировать маршрутный префикс, взяв за основу схему Inventory Service.

**Критерии выполнения:**
- [ ] Корневой префикс сервиса скорректирован так, чтобы запрос `GET /production/recipes` успешно обрабатывался без дополнительной переписи в nginx.
- [ ] Все публичные маршруты отражены в `docs/specs/production-service.md` (OpenAPI) и совпадают с Gateway конфигурацией `deploy/dev/api-gateway/nginx.conf`.
- [ ] Обновлён README сервиса с примером CURL.


---

**D-15: P-2 Обеспечение атомарности создания задания и резервирования инвентаря**
**Роль:** Backend Developer
**Приоритет:** Высокий  
**Статус:** [ ] Готов к выполнению

**Описание:**
Между созданием записи production-task в БД и вызовом `POST /inventory/reserve` отсутствует транзакционная целостность (Audit P-2). Нужно гарантировать атомарность операции во избежание «зависших» задач.

**Критерии выполнения:**
- [ ] Реализован надёжный механизм (Saga pattern либо Outbox + Consumer) обеспечивающий атомарность и идемпотентность.
- [ ] При любой ошибке резервирования запись задачи НЕ остаётся в статусе `pending`; происходит откат/удаление либо пометка `failed` с компенсацией зарезервированного инвентаря.
- [ ] Добавлены unit-тесты, эмулирующие сбой Inventory Service и проверяющие, что инварианты выполняются.
- [ ] Тестовое покрытие новой логики ≥80 %.
- [ ] Обновлена документация последовательности (sequence diagram) в `docs/architecture/`.

**Связанная документация:**
- `docs/architecture/production-task-atomic-creation.md` - детальное архитектурное решение с sequence диаграммами
- `docs/specs/production-service.md` (раздел "Атомарность создания заданий") - спецификация реализации Saga pattern
- `docs/specs/inventory-service.md` - необходимые эндпоинты для атомарности

**Зависимости:**
- Требует D-17: реализацию эндпоинта `GET /inventory/reservation/{operationID}` в Inventory Service

---

**D-16: P-5 Унификация конфигурации и переменных окружения в Production Service**
**Роль:** Backend/DevOps Developer
**Приоритет:** Высокий  
**Статус:** [ ] Готов к выполнению

**Описание:**
Параметры Production Service частично захардкожены и имеют небезопасные дефолты (Audit P-5). Необходимо перевести ВСЕ конфигурационные поля на загрузку из переменных окружения/конфиг-файла по аналогии с Inventory Service.

**Критерии выполнения:**
- [ ] Убраны дефолтные значения для обязательных параметров; приложение завершается с ошибкой при их отсутствии.
- [ ] Используется единый префикс `PROD_SVC_` для всех env-переменных.
- [ ] Поддерживается загрузка `config.yaml` + override из env (библиотека `viper`).
- [ ] Добавлен пример `config.sample.yaml` и секция *Configuration* в README.
- [ ] Unit-тесты проверяют корректную загрузку и валидацию конфигурации, включая fail-fast поведение.
- [ ] Docker/Compose файлы обновлены; переменные описаны в `.env.dev`.
- [ ] Линтинг и все тесты проходят.

---

**D-17: Реализация эндпоинта проверки статуса резервирования в Inventory Service**
**Роль:** Backend Developer
**Приоритет:** Высокий
**Статус:** [ ] Готов к выполнению

**Описание:**
Для поддержки атомарности производственных операций (D-15) требуется реализовать эндпоинт проверки статуса резервирования в Inventory Service. Этот эндпоинт необходим для background cleanup процессов Production Service.

**Критерии выполнения:**
- [ ] **Реализация эндпоинта**: `GET /inventory/reservation/{operationID}` возвращает информацию о резервировании
- [ ] **Проверка статуса**: Определение статуса резервирования (active/consumed/returned/not_found)
- [ ] **Возврат данных**: JSON с деталями резервирования согласно OpenAPI спецификации
- [ ] **Обработка ошибок**: Корректные HTTP коды (200, 404, 500)
- [ ] **Unit-тесты**: Покрытие всех сценариев (существующие/несуществующие резервы)
- [ ] **Интеграционные тесты**: Проверка работы с Production Service cleanup процессами
- [ ] **Документация**: Обновление README с примерами использования

**Связанные спецификации:**
- `docs/specs/inventory-service.md` - детальное описание эндпоинта
- `docs/specs/inventory-service-openapi.yml` - OpenAPI спецификация
- `docs/architecture/production-task-atomic-creation.md` - архитектурное решение

**Зависимости:**
- Блокирует реализацию D-15 (атомарные производственные операции)
- Требует доступ к таблице `operations` в БД inventory service

---

**D-12: Исправление HMAC валидации Telegram WebApp в production**
**Роль:** Backend Developer
**Приоритет:** Высокий  
**Статус:** [ ] Требует расследования и исправления

**Описание:**
Auth Service успешно аутентифицирует пользователей Telegram WebApp, но HMAC подпись не совпадает с ожидаемой. Временно HMAC валидация отключена для development среды, но это критично для production безопасности.

**🔍 Детали проблемы:**
- **Полученный hash**: `12620fff246f641d134e88ff4bb2e1ee2c58d8d9b677be8d0754b750ea453b89`  
- **Вычисленный hash**: `22781e9fc836aa91dab8348748721df21f81055d47ed8d3ac9f6516a2de150d5`
- **Бот токен**: `7986845757:AAG1L4612Tag4DtXyPMSMzDr_7pZHFdgTxM` (@SLCWDevDimBot)
- **Статус**: Все остальные проверки (auth_date, user data, структура) проходят успешно

**Возможные причины:**
1. Фронтенд инициализирован с другим ботом/токеном
2. Модификация initData после получения от Telegram  
3. Неправильная обработка URL encoding/JSON экранирования
4. Использование устаревшего Telegram WebApp API

**Критерии выполнения:**
- [ ] **Расследование**: Определить точную причину несовпадения HMAC
- [ ] **Проверка бота**: Убедиться что фронтенд использует правильный бот
- [ ] **Тестирование с оригинальными данными**: Проверить с реальными Telegram initData  
- [ ] **Исправление алгоритма**: При необходимости скорректировать валидацию
- [ ] **Включение строгой проверки**: Убрать временный bypass для production
- [ ] **Regression тесты**: Убедиться что исправление не ломает существующие тесты

**Временное решение:**
Аутентификация работает с предупреждением в логах `"Continuing despite HMAC validation failure for development"`

**Файлы для изучения:**
- `services/auth-service/internal/services/telegram.go:77-82` - место временного bypass
- Frontend инициализация Telegram WebApp
- Логи auth-service для анализа приходящих данных

---

**D-7: Внедрение метрик и мониторинга в Production Service**
**Роль:** DevOps/Backend Developer
**Приоритет:** Средний
**Статус:** [ ] Готов к выполнению

**Описание:**
Интеграция мониторинга и метрик для наблюдения за работой production-service по аналогии с auth-service и inventory-service.

**Критерии выполнения:**
- [ ] **Prometheus метрики**: HTTP метрики, бизнес-метрики производства, метрики модификаторов
- [ ] **Grafana дашборд**: Создание дашборда `production-service-metrics.json`
- [ ] **Алерты**: Правила алертов в `deploy/monitoring/alerts.yml`
- [ ] **Интеграция middleware**: Подключение метрик в HTTP handlers и бизнес-логику
- [ ] **Мониторинг производственных операций**: Метрики времени производства, успешности claim операций
- [ ] **Dependency health**: Мониторинг статуса inventory-service и user-service
- [ ] **Тестирование**: Проверка сбора метрик в dev окружении

**Файлы для изучения:**
- `services/auth-service/pkg/metrics/` - пример реализации
- `deploy/monitoring/grafana/dashboards/auth-service-metrics.json` - шаблон дашборда
- `docs/specs/production-service.md`

---
## Низкий приоритет
<!-- Задачи для будущих итераций -->

Эндпоинт для получения локализованной информации о предметах

**Критерии перехода в TODO:**
- [ ] Задача четко сформулирована
- [ ] Определены critical path критерии готовности  
- [ ] Проведена оценка трудозатрат
- [ ] Нет блокирующих зависимостей
- [ ] Назначен ответственный (опционально) 