# Задача 1: Создание скриптов миграции базы данных

## Описание

Создание SQL-скриптов миграции для инициализации схемы базы данных inventory-service. Включает создание таблиц, индексов, constraints и первичную заливку справочных данных.

## Цели

1. Создать структуру таблиц схемы `inventory`
2. Настроить все индексы и ограничения
3. Подготовить дистрибутивные данные классификаторов с фиксированными UUID
4. Обеспечить возможность откатов и повторных накаток

## Подзадачи

### 1.1. Создание структуры схемы
**Файл**: `migrations/001_create_inventory_schema.sql`

**Содержание**:
- Создание схемы `inventory`
- Создание таблицы `classifiers`
- Создание таблицы `classifier_items` 
- Создание таблицы `items`
- Создание таблицы `item_images`
- Создание таблицы `daily_balances`
- Создание таблицы `operations`

**Требования**:
- Все constraints из DBML схемы
- Все индексы для производительности
- Foreign key constraints
- Check constraints для валидации
- UUID default значения

### 1.2. Скрипт отката структуры
**Файл**: `migrations/001_create_inventory_schema_rollback.sql`

**Содержание**:
- Удаление всех таблиц в правильном порядке (учет FK)
- Удаление схемы `inventory`

### 1.3. Дистрибутивные данные классификаторов
**Файл**: `migrations/002_inventory_classifiers_data.sql`

**Содержание**:
- Вставка всех классификаторов с фиксированными UUID
- Вставка всех элементов классификаторов с фиксированными UUID
- Данные из спецификации inventory-service

**Особенности**:
- UUID генерируются один раз и фиксируются в скрипте
- Позволяет многократные откаты/накатки без изменения UUID
- Включает все 16 классификаторов и их элементы

### 1.4. Скрипт отката дистрибутивных данных
**Файл**: `migrations/002_inventory_classifiers_data_rollback.sql`

**Содержание**:
- Полная очистка таблиц `classifier_items` и `classifiers`
- Сброс sequences (если используются)

### 1.5. Тестовые данные для разработки
**Файл**: `migrations/003_inventory_test_data.sql`

**Содержание**:
- Создание тестовых предметов (items)
- Создание тестовых изображений (item_images)
- Создание тестовых операций для демонстрации
- Создание тестовых дневных остатков

## Критерии готовности

### Функциональные
- [ ] Все таблицы создаются без ошибок
- [ ] Все индексы работают корректно
- [ ] Foreign key constraints корректно настроены
- [ ] Дистрибутивные данные загружаются полностью
- [ ] Откат/накат работает без потери UUID

### Технические
- [ ] Скрипты проходят валидацию PostgreSQL
- [ ] Производительность создания таблиц приемлемая
- [ ] Размер индексов не превышает ожидаемых значений
- [ ] Все constraint names уникальны

### Проверочные
- [ ] Можно выполнить SELECT из всех таблиц
- [ ] Можно вставить тестовую операцию
- [ ] Можно рассчитать текущий остаток по формуле
- [ ] Все FK связи работают корректно

## Методы тестирования

### 1. Автоматические тесты
```sql
-- Проверка структуры
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'inventory';

-- Проверка данных
SELECT COUNT(*) FROM inventory.classifiers;
SELECT COUNT(*) FROM inventory.classifier_items;

-- Проверка constraints
SELECT constraint_name, constraint_type 
FROM information_schema.table_constraints 
WHERE table_schema = 'inventory';
```

### 2. Ручная проверка
- Выполнение миграций на чистой БД
- Проверка корректности данных через SQL-запросы
- Тестирование откатов и повторных накаток
- Валидация производительности запросов

### 3. Интеграционные тесты
- Подключение к БД из Go приложения
- Выполнение базовых CRUD операций
- Проверка работы с UUID и timestamp полями

## Зависимости

### Входящие
- Финальная схема database.dbml
- Спецификация inventory-service.md
- Настроенная PostgreSQL 17

### Исходящие
- Готовая БД для разработки API
- Скрипты для dev/staging/prod сред
- Документация по структуре данных

## Заметки по реализации

### UUID Стратегия
- Использовать фиксированные UUID в формате: `[classifier-код]-[4 цифры]-[суффикс]`
- Пример: `item-class-0001-resources-uuid`
- Обеспечивает читаемость и предсказуемость

### Структура файлов
```
migrations/
├── 001_create_inventory_schema.sql
├── 001_create_inventory_schema_rollback.sql
├── 002_inventory_classifiers_data.sql
├── 002_inventory_classifiers_data_rollback.sql
├── 003_inventory_test_data.sql
└── README.md
```

### Порядок выполнения
1. Выполнить 001 (структура)
2. Выполнить 002 (справочники)
3. Опционально выполнить 003 (тестовые данные)

## Риски и ограничения

- **Риск**: Изменение UUID в процессе разработки
  **Митигация**: Фиксация UUID в коде и документации

- **Риск**: Конфликты при параллельной разработке
  **Митигация**: Четкая документация порядка миграций

- **Ограничение**: Требует PostgreSQL 17+ для gen_random_uuid()
  **Решение**: Документировать требования к версии БД