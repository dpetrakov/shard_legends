# User Service Specification (Preliminary Version)

## Обзор

User Service — это микросервис для управления пользователями в игре Shard Legends: Clan Wars. Данная спецификация является **временной заглушечной версией** без собственной базы данных, предоставляющей моковые данные для первоначальной интеграции с сервисом производства.

**⚠️ ВРЕМЕННАЯ ВЕРСИЯ**: Этот сервис возвращает частично заглушенные данные и не имеет собственной базы данных. В будущих версиях будет реализована полная функциональность с персистентным хранилищем.

## Технические характеристики

- **Язык**: Golang
- **Архитектура**: Dual-port (публичный + внутренний порты)
- **Публичный порт**: 8080 (для API Gateway)
- **Внутренний порт**: 8090 (для межсервисного взаимодействия, health checks)
- **Порт для разработки**: 22005 (проброс внутреннего порта на хост)
- **База данных**: Отсутствует (временная версия)
- **Кеширование**: Redis (только для JWT validation)
- **Аутентификация**: JWT токены через Auth Service (валидация по RS256 подписи + проверка отзыва в Redis)
- **API**: RESTful JSON API
- **Документация**: OpenAPI 3.0
- **Архитектурное соответствие**: Inventory Service pattern

## JWT Аутентификация

### Процесс валидации JWT токенов

Все публичные эндпоинты требуют валидного JWT токена в заголовке `Authorization: Bearer <token>`.

**Последовательность проверки токена:**

1. **Проверка формата токена**
   - Извлечение токена из заголовка `Authorization`
   - Проверка префикса `Bearer `
   - Парсинг JWT структуры

2. **Валидация подписи JWT**
   - Получение публичного ключа RSA от Auth Service (`GET http://auth-service:8090/public-key.pem`)
   - Проверка RS256 подписи токена
   - Валидация алгоритма подписи

3. **Проверка времени действия**
   - Автоматическая проверка `exp` claim в JWT
   - Отклонение просроченных токенов

4. **Проверка отзыва токена**
   - Извлечение `jti` (JWT ID) из токена
   - Проверка в Redis: `EXISTS revoked:{jti}`
   - Отклонение отозванных токенов

5. **Извлечение данных пользователя**
   - Получение `user_id` из claim `sub`
   - Получение `telegram_id` из claim `telegram_id`
   - Сохранение в контексте запроса

**Структура JWT токена:**
```json
{
  "iss": "shard-legends-auth",
  "sub": "uuid-internal-user-id",
  "telegram_id": 123456789,
  "iat": 1703243400,
  "exp": 1703329800,
  "jti": "uuid-token-id"
}
```

**Возможные ошибки аутентификации:**
- `missing_token` (401) - Отсутствует заголовок Authorization
- `invalid_token_format` (401) - Неправильный формат Bearer токена
- `invalid_token_signature` (401) - Неверная подпись JWT
- `invalid_token_claims` (401) - Некорректные claims в токене
- `missing_token_id` (401) - Отсутствует JTI в токене
- `token_revoked` (401) - Токен отозван
- `missing_user_id` (401) - Отсутствует user_id в токене

**Зависимости:**
- Auth Service для получения публичного ключа
- Redis для проверки отозванных токенов
- JWT библиотека для парсинга и валидации

## API Endpoints

### Архитектура портов и маршрутизация

**Публичный порт 8080:**
- Доступен только через API Gateway
- Требует JWT аутентификацию
- Только business endpoints

**Внутренний порт 8090:**
- Прямой доступ в контейнерной сети
- Проброс на localhost:22005 для разработки
- Без аутентификации (межсервисное взаимодействие)
- Health checks и internal API

### Публичные эндпоинты (через API Gateway)

#### Получение профиля пользователя
```
GET /api/user/profile → user-service:8080/profile
```

**Описание:** Возвращает данные профиля пользователя для отображения на странице профиля

**Аутентификация**: Требует валидный JWT токен в заголовке `Authorization: Bearer <token>`

**Выходные данные:**
```json
{
  "user_id": "uuid-from-jwt",
  "telegram_id": 123456789,
  "display_name": "John Doe",
  "vip_status": {
    "is_active": true,
    "expires_at": "2025-01-15T10:30:00Z"
  },
  "profile_image": "https://t.me/i/userpic/320/abc123.jpg",
  "level": 15,
  "experience": 2850,
  "achievements_count": 7,
  "clan": {
    "id": "clan-uuid",
    "name": "Dragon Warriors",
    "role": "member"
  }
}
```

**Логика формирования данных (временная версия):**
1. **Из JWT токена**: `user_id`, `telegram_id`
2. **Моковые данные**: Случайная генерация VIP статуса и времени окончания
3. **Заглушечные данные**: Фиксированные значения для уровня, опыта, достижений
4. **Статическая информация**: Фиксированные данные клана

**Особенности временной реализации:**
- VIP статус генерируется случайно (30% вероятность активного VIP)
- Время окончания VIP от 1 до 30 дней от текущей даты
- Все остальные поля заполняются статическими значениями
- Отсутствует персистентность между запросами

#### Получение производственных слотов
```
GET /api/user/production-slots → user-service:8080/production-slots
```

**Описание:** Возвращает информацию о доступных производственных слотах пользователя

**Аутентификация**: Требует валидный JWT токен в заголовке `Authorization: Bearer <token>`

**Выходные данные:**
```json
{
  "user_id": "uuid-from-jwt",
  "total_slots": 2,
  "slots": [
    {
      "slot_type": "universal",
      "supported_operations": ["crafting", "smelting", "chest_opening"],
      "count": 2
    }
  ]
}
```

**Логика формирования данных (временная версия):**
- **Фиксированное значение**: Всегда возвращает 2 универсальных слота
- **Поддерживаемые операции**: Статический список основных типов производства
- **user_id**: Извлекается из JWT токена

**Обоснование возвращаемых данных:**
Универсальные слоты поддерживают все основные типы производственных операций, что позволяет Production Service корректно обрабатывать любые рецепты в рамках доступных лимитов.

### Внутренние эндпоинты (прямой доступ, порт 8090)

#### Health Check
```
GET localhost:22005/health (или user-service:8090/health в сети)
```

**Описание:** Проверка работоспособности сервиса

**Аутентификация**: Не требуется

**Выходные данные:**
```json
{
  "status": "healthy",
  "timestamp": "2025-06-28T19:25:07Z",
  "version": "1.0.0",
  "service": "user-service"
}
```

#### Readiness Check
```
GET localhost:22005/ready (или user-service:8090/ready в сети)
```

**Описание:** Проверка готовности сервиса к обработке запросов

**Аутентификация**: Не требуется

**Выходные данные:** Аналогично health check

#### Получение производственных слотов пользователя
```
GET localhost:22005/users/{user_id}/production-slots
GET user-service:8090/users/{user_id}/production-slots (в сети)
```

**Описание:** Внутренний эндпоинт для Production Service для получения информации о слотах

**Аутентификация**: Внутренний эндпоинт, не требует JWT (доступ только внутри сети)

**Входные параметры:**
- `user_id` - UUID пользователя из пути

**Выходные данные:**
```json
{
  "user_id": "user-uuid-from-path",
  "total_slots": 2,
  "slots": [
    {
      "slot_type": "universal",
      "supported_operations": ["crafting", "smelting", "chest_opening"],
      "count": 2
    }
  ]
}
```

**Логика (временная версия):**
- Всегда возвращает 2 универсальных слота независимо от user_id
- Не выполняет проверку существования пользователя

#### Получение модификаторов пользователя
```
GET localhost:22005/users/{user_id}/production-modifiers
GET user-service:8090/users/{user_id}/production-modifiers (в сети)
```

**Описание:** Внутренний эндпоинт для Production Service для получения пользовательских модификаторов

**Аутентификация**: Внутренний эндпоинт, не требует JWT (доступ только внутри сети)

**Входные параметры:**
- `user_id` - UUID пользователя из пути

**Выходные данные:**
```json
{
  "user_id": "user-uuid-from-path",
  "modifiers": {
    "vip_status": {
      "level": "none",
      "production_speed_bonus": 0.0,
      "quality_bonus": 0.0
    },
    "character_level": {
      "level": 1,
      "crafting_bonus": 0.0
    },
    "achievements": [],
    "clan_bonuses": {
      "production_speed": 0.0
    }
  }
}
```

**Логика (временная версия):**
- Возвращает нулевые модификаторы для всех пользователей
- Минимальный уровень персонажа (1)
- Отсутствие VIP бонусов и достижений
- Нулевые клановые бонусы

## Модель данных

### Отсутствие персистентного хранилища

**Важно**: В данной временной версии сервис НЕ имеет собственной базы данных и НЕ сохраняет пользовательские данные.

**Источники данных:**
1. **JWT токены** - единственный источник идентификации пользователя
2. **Статические конфигурации** - фиксированные значения слотов и модификаторов
3. **Случайная генерация** - для VIP статуса (не персистентная)

**Ограничения временной версии:**
- Нет пользовательского прогресса
- Нет сохранения настроек
- Нет истории действий
- VIP статус может отличаться между запросами
- Отсутствует синхронизация с другими сервисами

## Бизнес-логика

### Обработка VIP статуса (временная)

**Алгоритм генерации VIP статуса:**
1. Генерация случайного числа от 0 до 1
2. Если число < 0.3 → VIP активен
3. Если VIP активен → случайная дата окончания от 1 до 30 дней
4. Если VIP неактивен → expires_at = null

**Пример кода генерации:**
```go
func generateMockVIPStatus() VIPStatus {
    if rand.Float32() < 0.3 {
        expirationDays := rand.Intn(30) + 1
        expiresAt := time.Now().AddDate(0, 0, expirationDays)
        return VIPStatus{
            IsActive:  true,
            ExpiresAt: &expiresAt,
        }
    }
    return VIPStatus{
        IsActive:  false,
        ExpiresAt: nil,
    }
}
```

### Управление производственными слотами (временная)

**Текущая реализация:**
- Все пользователи имеют одинаковое количество слотов (2)
- Все слоты универсального типа
- Поддержка основных операций: крафт, переплавка, открытие сундуков

**Планируемые улучшения:**
В будущих версиях будут добавлены:
- Персональные лимиты слотов
- Специализированные слоты
- Возможность улучшения через VIP или достижения
- Временные бонусы к количеству слотов

## Безопасность

**Архитектурная безопасность:**
- **Разделение портов**: Публичные (8080) и внутренние (8090) эндпоинты изолированы
- **API Gateway фильтрация**: Health эндпоинты недоступны через внешний доступ
- **Сетевая изоляция**: Внутренние эндпоинты доступны только в Docker сети

**Защита внутренних эндпоинтов (порт 8090):**
- Доступ только из внутренней сети контейнеров
- Проброс на localhost:22005 только для разработки
- Отсутствие внешнего роутинга через API Gateway
- Валидация формата UUID в параметрах пути

**Публичные эндпоинты (порт 8080):**
- Доступ только через API Gateway
- Строгая валидация JWT токенов
- Проверка отзыва токенов в Redis  
- Rate limiting (наследуется от API Gateway)

**Проверка изоляции:**
```bash
# ✅ Работает - внутренние эндпоинты
curl localhost:22005/health

# ❌ 404 - health недоступен через API Gateway  
curl localhost:9000/api/user/health

# ❌ 401 - публичные эндпоинты требуют JWT
curl localhost:9000/api/user/profile
```

## Зависимости

- **Auth Service**: для получения публичного ключа JWT и проверки отзыва токенов
- **Redis**: для проверки статуса токенов (только чтение)

**Отсутствующие зависимости в временной версии:**
- PostgreSQL или другая БД для хранения пользовательских данных
- Event Service для событийных модификаторов
- Clan Service для клановой информации

## Требования к реализации

### Обязательные компоненты
1. **JWT middleware** с проверкой подписи и отзыва
2. **Моковые handlers** для двух публичных эндпоинтов
3. **Внутренние handlers** для интеграции с Production Service
4. **Случайная генерация VIP** статуса
5. **Статические данные** для слотов и модификаторов

### Исключения для временной версии
- **Отсутствие unit-тестов** (как указано в требованиях)
- **Отсутствие метрик** (как указано в требованиях)
- **Минимальное логирование** (базовые access logs)
- **Простая конфигурация** через переменные окружения

### Структура проекта

```
services/user-service/
├── cmd/
│   └── server/
│       └── main.go               # Dual-port server setup
├── internal/
│   ├── handlers/
│   │   ├── health.go             # Health & ready endpoints  
│   │   ├── public/
│   │   │   └── profile.go        # Public endpoints (JWT auth)
│   │   └── api/
│   │       └── user.go           # Internal endpoints (no auth)
│   ├── middleware/
│   │   └── auth.go               # JWT authentication middleware
│   ├── models/
│   │   ├── user.go
│   │   └── production.go
│   ├── services/
│   │   └── mock_data.go          # Mock data generation
│   └── config/
│       └── config.go             # Dual-port configuration
├── pkg/
│   ├── jwt/
│   │   └── validator.go          # JWT validation utilities
│   └── logger/
│       └── logger.go             # Structured logging
├── Dockerfile                    # Multi-port container setup
├── go.mod
├── go.sum
└── README.md
```

### Конфигурационные переменные

**Обязательные переменные:**
```bash
USER_SERVICE_HOST=0.0.0.0
USER_SERVICE_PORT=8080                    # Публичный порт
USER_SERVICE_INTERNAL_PORT=8090           # Внутренний порт
AUTH_SERVICE_PUBLIC_KEY_URL=http://auth-service:8090/public-key.pem
REDIS_AUTH_URL=redis://redis:6379/0       # JWT validation
```

**Развёртывание (docker-compose):**
```yaml
user-service:
  ports:
    - "127.0.0.1:22005:8090"              # Внутренний порт на хост
  healthcheck:
    test: ["CMD", "wget", "--spider", "-q", "http://localhost:8090/health"]
```

## Примеры использования и тестирования

### Внутренние эндпоинты (разработка)

**Health Check:**
```bash
curl -s localhost:22005/health | jq
{
  "status": "healthy",
  "timestamp": "2025-06-28T19:25:07Z",
  "version": "1.0.0", 
  "service": "user-service"
}
```

**Production Slots:**
```bash
curl -s localhost:22005/users/test-user-123/production-slots | jq
{
  "user_id": "test-user-123",
  "total_slots": 2,
  "slots": [
    {
      "slot_type": "universal",
      "supported_operations": ["crafting", "smelting", "chest_opening"],
      "count": 2
    }
  ]
}
```

**Production Modifiers:**
```bash
curl -s localhost:22005/users/test-user-123/production-modifiers | jq
{
  "user_id": "test-user-123",
  "modifiers": {
    "vip_status": {
      "level": "none",
      "production_speed_bonus": 0,
      "quality_bonus": 0
    },
    "character_level": {
      "level": 1,
      "crafting_bonus": 0
    },
    "achievements": [],
    "clan_bonuses": {
      "production_speed": 0
    }
  }
}
```

### Публичные эндпоинты (через API Gateway)

**Без JWT токена (ошибка):**
```bash
curl -s localhost:9000/api/user/profile | jq
{
  "error": "missing_token",
  "message": "Missing Authorization header"
}
```

**Проверка недоступности health через API Gateway:**
```bash
curl -s -I localhost:9000/api/user/health
HTTP/1.1 404 Not Found
```

### Интеграция с Production Service

Production Service может обращаться к User Service внутренними эндпоинтами:

```go
// В Production Service
userSlotsURL := fmt.Sprintf("http://user-service:8090/users/%s/production-slots", userID)
resp, err := http.Get(userSlotsURL)
```

## Переход к полной версии

### Планируемые доработки
1. **Добавление PostgreSQL** для персистентного хранения пользовательских данных
2. **Интеграция с Auth Service** для синхронизации пользователей
3. **Реальная VIP система** с подписками и платежами
4. **Система уровней и опыта** с прогрессией
5. **Достижения и награды** с условиями получения
6. **Клановая система** с ролями и бонусами
7. **Производственные модификаторы** от экипировки и улучшений

### Миграционная стратегия
При переходе к полной версии данные из временной заглушки не сохраняются. Будет реализована система импорта базовых данных пользователей из Auth Service.

---

**Примечание**: Данная спецификация является первоначальной версией для обеспечения базовой интеграции с Production Service. В ближайших релизах планируется расширение функциональности до полноценного сервиса управления пользователями.