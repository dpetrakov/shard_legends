# Спецификация классификаторов системы Shard Legends: Clan Wars

## Обзор

Классификаторы представляют собой справочную систему для хранения всех перечисляемых типов и значений, используемых в игре. Все классификаторы управляются исключительно через скрипты миграции базы данных для обеспечения версионности и консистентности данных между окружениями.

## Принципы работы с классификаторами

### Механизм управления
- **Только через миграции** - все изменения классификаторов выполняются через SQL миграции
- **Версионность** - полная история изменений в системе контроля версий
- **Консистентность** - одинаковые данные во всех окружениях (dev, staging, production)
- **Безопасность** - исключение случайных изменений через API

### Структура данных
```sql
-- Классификатор (тип справочника)
CREATE TABLE classifiers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(100) UNIQUE NOT NULL,
    description TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Элемент классификатора (конкретное значение)
CREATE TABLE classifier_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    classifier_id UUID NOT NULL REFERENCES classifiers(id),
    code VARCHAR(100) NOT NULL,
    description TEXT NOT NULL,
    sort_order INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    UNIQUE(classifier_id, code)
);
```

## Классификаторы системы

### CL001: Классы предметов (item_class)
**Идентификатор**: `CL001`
**Код**: `item_class`
**Описание**: Высший уровень группировки игровых предметов

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `resources` | Базовые ресурсы для строительства и производства | `CLI001` |
| `reagents` | Реагенты для производства инструментов | `CLI002` |
| `boosters` | Ускорители различных процессов | `CLI003` |
| `blueprints` | Чертежи для производства инструментов | `CLI004` |
| `tools` | Инструменты для добычи ресурсов | `CLI005` |
| `keys` | Ключи для открытия сундуков | `CLI006` |
| `currencies` | Игровые валюты | `CLI007` |
| `chests` | Сундуки с различными наградами | `CLI008` |

### CL002: Типы ресурсов (resource_type)
**Идентификатор**: `CL002`
**Код**: `resource_type`
**Описание**: Подтипы ресурсов для класса resources

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `stone` | Камень | `CLI009` |
| `wood` | Дерево | `CLI010` |
| `ore` | Руда | `CLI011` |
| `diamond` | Алмаз | `CLI012` |

### CL003: Типы реагентов (reagent_type)
**Идентификатор**: `CL003`
**Код**: `reagent_type`
**Описание**: Подтипы реагентов для класса reagents

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `abrasive` | Абразив | `CLI013` |
| `disc` | Диск | `CLI014` |
| `inductor` | Индуктор | `CLI015` |
| `paste` | Паста | `CLI016` |

### CL004: Типы ускорителей (booster_type)
**Идентификатор**: `CL004`
**Код**: `booster_type`
**Описание**: Подтипы ускорителей для класса boosters

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `repair_tool` | Починка инструмента | `CLI017` |
| `speed_processing` | Ускорение переработки | `CLI018` |
| `speed_crafting` | Ускорение создания | `CLI019` |

### CL005: Типы инструментов (tool_type)
**Идентификатор**: `CL005`
**Код**: `tool_type`
**Описание**: Подтипы инструментов для класса tools

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `shovel` | Лопата | `CLI020` |
| `sickle` | Серп | `CLI021` |
| `axe` | Топор | `CLI022` |
| `pickaxe` | Кирка | `CLI023` |

### CL006: Типы ключей (key_type)
**Идентификатор**: `CL006`
**Код**: `key_type`
**Описание**: Подтипы ключей для класса keys

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `key` | Обычный ключ | `CLI024` |
| `blueprint_key` | Ключ для чертежей | `CLI025` |

### CL007: Типы валют (currency_type)
**Идентификатор**: `CL007`
**Код**: `currency_type`
**Описание**: Подтипы валют для класса currencies

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `diamonds` | Диаманты | `CLI026` |

### CL009: Уровни качества (quality_level)
**Идентификатор**: `CL009`
**Код**: `quality_level`
**Описание**: Уровни качества предметов

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `base` | Базовый уровень (для ресурсов, реагентов, ускорителей) | `CLI032` |
| `wooden` | Деревянный уровень (для инструментов) | `CLI033` |
| `stone` | Каменный уровень (для инструментов) | `CLI034` |
| `metal` | Металлический уровень (для инструментов) | `CLI035` |
| `diamond` | Бриллиантовый уровень (для инструментов) | `CLI036` |
| `small` | Малый размер (для сундуков и ключей Key-S) | `CLI037` |
| `medium` | Средний размер (для сундуков и ключей Key-M) | `CLI038` |
| `large` | Большой размер (для сундуков и ключей Key-L) | `CLI039` |

### CL010: Коллекции (collection)
**Идентификатор**: `CL010`
**Код**: `collection`
**Описание**: Коллекции предметов (сезонные и базовые)

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `base` | Базовая коллекция (для всех типов предметов) | `CLI040` |


### CL011: Разделы инвентаря (inventory_section)
**Идентификатор**: `CL011`
**Код**: `inventory_section`
**Описание**: Разделы инвентаря пользователя

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `main` | Основной инвентарь пользователя | `CLI045` |
| `factory` | Фабричный инвентарь (зарезервированные материалы) | `CLI046` |

### CL012: Типы операций инвентаря (operation_type)
**Идентификатор**: `CL012`
**Код**: `operation_type`
**Описание**: Типы операций с инвентарем

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `chest_reward` | Получение из сундука | `CLI048` |
| `craft_result` | Результат производства | `CLI049` |
| `admin_adjustment` | Административная корректировка | `CLI052` |
| `system_reward` | Системная награда | `CLI053` |
| `system_penalty` | Системное списание | `CLI054` |
| `daily_quest_reward` | Награда за ежедневное задание | `CLI055` |
| `factory_reservation` | Резервирование материалов для производства | `CLI056` |
| `factory_return` | Возврат материалов при отмене | `CLI057` |
| `factory_consumption` | Уничтожение материалов при производстве | `CLI058` |

### CL013: Классы производственных операций (production_operation_class)
**Идентификатор**: `CL013`
**Код**: `production_operation_class`
**Описание**: Классы операций для производственных процессов

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `crafting` | Крафт инструментов, создание предметов | `CLI061` |
| `smelting` | Переплавка, обработка сырья | `CLI062` |
| `chest_opening` | Открытие сундуков | `CLI063` |

### CL014: Типы лимитов рецептов (recipe_limit_type)
**Идентификатор**: `CL014`
**Код**: `recipe_limit_type`
**Описание**: Типы временных ограничений для производственных рецептов

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `total` | Общий лимит на все время жизни профиля | `CLI066` |
| `per_day` | Лимит на календарные сутки (00:00-23:59 UTC) | `CLI067` |
| `per_week` | Лимит на календарную неделю (понедельник-воскресенье) | `CLI068` |
| `per_month` | Лимит на календарный месяц | `CLI069` |
| `per_quarter` | Лимит на квартал (3 месяца) | `CLI070` |
| `per_year` | Лимит на календарный год | `CLI071` |
| `per_season` | Лимит на сезон (4 недели для чертежей) | `CLI072` |
| `per_event` | Лимит на все время проведения события | `CLI073` |

### CL015: Объекты лимитов рецептов (recipe_limit_object)
**Идентификатор**: `CL015`
**Код**: `recipe_limit_object`
**Описание**: Объекты ограничений для производственных рецептов

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `recipe_execution` | Ограничение на количество запусков рецепта | `CLI074` |
| `item_receipt` | Ограничение на количество получений конкретного предмета | `CLI075` |

### CL016: Статусы производственных заданий (production_task_status)
**Идентификатор**: `CL016`
**Код**: `production_task_status`
**Описание**: Возможные статусы производственных заданий

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `pending` | Ожидает свободного слота для запуска | `CLI076` |
| `in_progress` | Выполняется в производственном слоте | `CLI077` |
| `completed` | Завершено, результат готов к Claim | `CLI078` |
| `claimed` | Результат получен пользователем | `CLI079` |
| `cancelled` | Отменено до начала выполнения | `CLI080` |
| `failed` | Не удалось выполнить по техническим причинам | `CLI081` |

### CL017: Типы производственных слотов (production_slot_type)
**Идентификатор**: `CL017`
**Код**: `production_slot_type`
**Описание**: Типы производственных слотов пользователя

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `universal` | Универсальный слот (поддерживает все операции) | `CLI082` |
| `smithy` | Кузнечный слот (crafting + smelting) | `CLI083` |
| `crafting` | Слот для операции крафта (crafting) | `CLI100` |
| `smelting` | Слот для операции переплавки (smelting) | `CLI101` |
| `chest_opening` | Слот для операции открытия сундуков (chest_opening) | `CLI102` |
| `mining` | Шахтерский слот (resource_gathering) | `CLI084` |
| `special` | Специальный слот (special) | `CLI085` |

### CL018: Типы модификаторов (modifier_type)
**Идентификатор**: `CL018`
**Код**: `modifier_type`
**Описание**: Типы модификаторов для производственных процессов

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `speed_bonus` | Ускорение производства (сокращение времени) | `CLI086` |
| `quantity_bonus` | Увеличение количества (модификация диапазонов) | `CLI087` |
| `probability_bonus` | Повышение шансов (улучшение вероятностей) | `CLI088` |
| `cost_reduction` | Снижение затрат (уменьшение материалов) | `CLI089` |
| `quality_bonus` | Повышение качества результата | `CLI090` |

### CL019: Источники модификаторов (modifier_source)
**Идентификатор**: `CL019`
**Код**: `modifier_source`
**Описание**: Источники происхождения модификаторов

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `booster_item` | Модификатор от предмета-ускорителя | `CLI091` |
| `vip_status` | Модификатор от VIP статуса | `CLI092` |
| `character_level` | Модификатор от уровня персонажа | `CLI093` |
| `achievement` | Модификатор от достижения | `CLI094` |
| `clan_bonus` | Модификатор от клановых бонусов | `CLI095` |
| `seasonal_event` | Модификатор от сезонного события | `CLI096` |
| `lunar_cycle` | Модификатор от лунного цикла | `CLI097` |
| `server_buff` | Модификатор от серверного бафа | `CLI098` |
| `special_event` | Модификатор от специального события | `CLI099` |


### CL021: Статусы пользователей (user_status)
**Идентификатор**: `CL021`
**Код**: `user_status`
**Описание**: Статусы активности пользователей

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `active` | Активный пользователь | `CLI104` |
| `inactive` | Неактивный пользователь | `CLI105` |
| `suspended` | Заблокированный пользователь | `CLI106` |
| `banned` | Забаненный пользователь | `CLI107` |
| `under_investigation` | Подозрение в мошенничестве (ограниченные действия до расследования) | `CLI133` |
| `shadow_restricted` | Ограниченный статус для подтверждённых мошенников (игра без полноценной выгоды) | `CLI134` |


### CL025: Уровни качества инструментов (tool_quality_levels)
**Идентификатор**: `CL025`
**Код**: `tool_quality_levels`
**Описание**: Доступные уровни качества для инструментов

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `wooden` | Деревянный инструмент | `CLI126` |
| `stone` | Каменный инструмент | `CLI127` |
| `metal` | Металлический инструмент | `CLI128` |
| `diamond` | Бриллиантовый инструмент | `CLI129` |

### CL026: Уровни качества ключей (key_quality_levels)
**Идентификатор**: `CL026`
**Код**: `key_quality_levels`
**Описание**: Доступные уровни качества для ключей

| Код элемента | Описание | Идентификатор |
|--------------|----------|---------------|
| `small` | Малый ключ (Key-S) | `CLI130` |
| `medium` | Средний ключ (Key-M) | `CLI131` |
| `large` | Большой ключ (Key-L) | `CLI132` |

## Дополнительные настройки классификаторов

### Метаклассификаторы качества для классов предметов

Для обеспечения гибкости системы, определены связи между классами предметов и доступными для них уровнями качества:

#### Ресурсы, реагенты, ускорители, чертежи, валюты, сундуки
- Используют только уровень качества `base`

#### Инструменты
- Доступные уровни: `wooden`, `stone`, `metal`, `diamond`

#### Ключи
- Доступные уровни: `small`, `medium`, `large` (для обычных ключей)
- Уровень `base` (для чертежных ключей)

### Правила наследования коллекций

#### Всегда базовая коллекция
- `resources`, `reagents`, `boosters`, `currencies`, `keys`, `chests`

#### Поддержка сезонных коллекций
- `blueprints`: всегда используют актуальную сезонную коллекцию
- `tools`: могут наследовать коллекцию от чертежей при крафте

### Системные константы

#### Ключевые слова для коллекций
- `CURRENT_SEASON` - автоматическая подстановка актуальной сезонной коллекции
- `BASE_COLLECTION` - явное указание базовой коллекции

## Управление миграциями классификаторов

### Расположение файлов миграций
```
migrations/
├── classifiers/
│   ├── 001_create_classifiers_schema.up.sql
│   ├── 001_create_classifiers_schema.down.sql
│   ├── 002_populate_core_classifiers.up.sql
│   ├── 002_populate_core_classifiers.down.sql
│   ├── 003_add_seasonal_collections_2025.up.sql
│   ├── 003_add_seasonal_collections_2025.down.sql
│   └── ...
```

### Шаблон миграции для добавления классификатора

```sql
-- Добавление нового классификатора
INSERT INTO classifiers (id, code, description) VALUES 
('новый-uuid', 'новый_код', 'Описание классификатора');

-- Добавление элементов классификатора
INSERT INTO classifier_items (id, classifier_id, code, description, sort_order) VALUES 
('элемент-uuid-1', 'новый-uuid', 'код_элемента_1', 'Описание элемента 1', 1),
('элемент-uuid-2', 'новый-uuid', 'код_элемента_2', 'Описание элемента 2', 2);
```

### Правила изменения классификаторов

1. **Никогда не удаляем классификаторы и элементы** - только деактивируем через `is_active = false`
2. **Фиксированные UUID** для стабильности ссылок между таблицами
3. **Обязательный down скрипт** для возможности отката миграций
4. **Сохранение истории** для аудита и анализа изменений

## Принципы использования в коде

### API работает с кодами, БД хранит UUID
```go
// Входящий запрос
{
  "item_class": "tools",
  "quality_level": "wooden",
  "collection": "winter_2025"
}

// Сохранение в БД
{
  "item_class_id": "CLI005", // UUID из classifier_items
  "quality_level_id": "CLI033", // UUID из classifier_items  
  "collection_id": "CLI041" // UUID из classifier_items
}
```

### Преобразование кодов в UUID и обратно
Сервисы должны реализовать функции:
- `convertClassifierCodes(toUUID)` - преобразование кодов в UUID для записи в БД
- `convertClassifierCodes(fromUUID)` - преобразование UUID в коды для API ответов

### Кеширование классификаторов
- **Срок жизни кеша**: 24 часа
- **Ключ кеша**: `classifiers:mapping` 
- **Содержимое**: полное двунаправленное отображение код ↔ UUID для всех классификаторов
- **Инвалидация**: при применении миграций классификаторов

## Контроль качества

### Валидация при добавлении
- Уникальность кодов в рамках классификатора
- Соответствие формату кодов (snake_case)
- Обязательность описаний на русском языке
- Корректность UUID (version 4)

### Тестирование
- Unit тесты для функций преобразования кодов
- Integration тесты для проверки консистентности данных
- Валидация целостности после применения миграций

Данная спецификация обеспечивает централизованное управление всеми справочными данными системы с полным контролем версий и безопасностью изменений.
