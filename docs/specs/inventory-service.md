# Inventory Service Specification

## Обзор

Inventory Service - это микросервис для управления инвентарем пользователей в игре Shard Legends: Clan Wars. Сервис обеспечивает хранение, учет и операции с игровыми предметами, а также управление справочными данными через общий классификатор.

## Технические характеристики

- **Язык**: Golang
- **Порт**: 8080 (внутренний)
- **База данных**: PostgreSQL 17 (схема `inventory`)
- **Кеширование**: Redis 8.0.2
- **Аутентификация**: JWT токены через Auth Service (валидация по RS256 подписи + проверка отзыва в Redis)
- **API**: RESTful JSON API
- **Документация**: OpenAPI 3.0

## JWT Аутентификация

### Процесс валидации JWT токенов

Все публичные и административные эндпоинты требуют валидного JWT токена в заголовке `Authorization: Bearer <token>`.

**Последовательность проверки токена:**

1. **Проверка формата токена**
   - Извлечение токена из заголовка `Authorization`
   - Проверка префикса `Bearer `
   - Парсинг JWT структуры

2. **Валидация подписи JWT**
   - Получение публичного ключа RSA от Auth Service (`GET http://auth-service:8080/public-key.pem`)
   - Проверка RS256 подписи токена
   - Валидация алгоритма подписи

3. **Проверка времени действия**
   - Автоматическая проверка `exp` claim в JWT
   - Отклонение просроченных токенов

4. **Проверка отзыва токена**
   - Извлечение `jti` (JWT ID) из токена
   - Проверка в Redis: `EXISTS revoked:{jti}`
   - Отклонение отозванных токенов

5. **Извлечение данных пользователя**
   - Получение `user_id` из claim `sub`
   - Получение `telegram_id` из claim `telegram_id`
   - Сохранение в контексте запроса

**Структура JWT токена:**
```json
{
  "iss": "shard-legends-auth",
  "sub": "uuid-internal-user-id",
  "telegram_id": 123456789,
  "iat": 1703243400,
  "exp": 1703329800,
  "jti": "uuid-token-id"
}
```

**Возможные ошибки аутентификации:**
- `missing_token` (401) - Отсутствует заголовок Authorization
- `invalid_token_format` (401) - Неправильный формат Bearer токена
- `invalid_token_signature` (401) - Неверная подпись JWT
- `invalid_token_claims` (401) - Некорректные claims в токене
- `missing_token_id` (401) - Отсутствует JTI в токене
- `token_revoked` (401) - Токен отозван
- `missing_user_id` (401) - Отсутствует user_id в токене

**Зависимости:**
- Auth Service для получения публичного ключа
- Redis для проверки отозванных токенов
- JWT библиотека для парсинга и валидации

## API Endpoints

### Публичные эндпоинты (для фронтенда)

#### Получение инвентаря
```
GET /inventory
```

**Описание:** Возвращает текущее состояние инвентаря пользователя

**Входные параметры:**
- Раздел инвентаря (опционально)
- ID пользователя (из JWT токена после валидации)

**Аутентификация**: Требует валидный JWT токен в заголовке `Authorization: Bearer <token>`

**Действия при вызове:**
1. Извлечь user_id из JWT токена
2. Получить список уникальных комбинаций предметов в разделе
3. Для каждой комбинации:
   - Вызвать `calculateCurrentBalance` для получения текущего остатка
4. Преобразовать UUID в коды через `convertClassifierCodes(fromUUID)`
5. Отфильтровать предметы с нулевым остатком
6. Вернуть список предметов с положительными остатками

**Выходные данные:**
- Список предметов с их текущими количествами

**Изменения в БД:** Нет (только чтение)

#### Получение локализованной информации о предметах
```
POST /items/details?lang=<ru|en>
```

**Описание:** Возвращает локализованные названия, описания и изображения для списка предметов. Использует кеширование и fallback на дефолтный язык при отсутствии перевода.

**Входные параметры:**
- Query-параметр `lang` – язык локализации (`ru`, `en`). Если параметр не указан, Inventory Service определяет язык по классификатору `i18n.languages`, где помечён `is_default = true`.
- Тело запроса: `{ "items": [ { "item_id": "uuid", "collection": "winter_2025", "quality_level": "stone" } ] }`

**Аутентификация**: Требует валидный JWT токен `Authorization: Bearer <token>`

**Пример ответа:**
```json
{
  "items": [
    {
      "item_id": "1ac8c2b0-0a7d-4e0e-a6d2-9a90b9094b60",
      "item_class": "chests",
      "item_type": "stone",
      "name": "Каменный сундук",
      "description": "Содержит случайную награду из набора Stone",
      "image_url": "https://cdn.example.com/items/stone_chest.png",
      "collection": "winter_2025",
      "quality_level": "stone"
    }
  ]
}
```

**Изменения:** В версии 1.0.1 поле `code` переименовано в `item_type`, добавлено поле `item_class`.

### Внутренние эндпоинты (для других сервисов)

#### Резервирование предметов (для Factory Service)
```
POST /inventory/reserve
```

**Описание:** Резервирует предметы для производственного задания, перемещая их из основного в фабричный инвентарь

**Входные параметры:**
- ID пользователя
- ID операции (для связи с производственным заданием)
- Список предметов с количествами для резервирования

**Действия при вызове:**
1. Преобразовать коды в UUID через `convertClassifierCodes(toUUID)`
2. Вызвать `checkSufficientBalance` для проверки наличия всех предметов
3. Начать транзакцию БД
4. Подготовить массив операций (по 2 на каждый предмет):
   - Списание из основного инвентаря (отрицательный quantity_change)
   - Зачисление в фабричный инвентарь (положительный quantity_change)
   - Обе с типом "factory_reservation" и одинаковым operation_id
5. Вызвать `createOperationsInTransaction` для создания операций
6. Зафиксировать транзакцию

**Выходные данные:**
- Успех/неуспех операции
- При ошибке - детали о недостающих предметах

**Изменения в БД:**
- Добавление записей в `operations` (по 2 на каждый предмет)

#### Возврат резерва
```
POST /inventory/return-reserve
```

**Описание:** Возвращает зарезервированные предметы из фабричного в основной инвентарь при отмене производства

**Входные параметры:**
- ID пользователя
- ID операции резервирования

**Действия при вызове:**
1. Найти все операции резервирования по operation_id в `operations`
2. Начать транзакцию БД
3. Для каждой пары операций резервирования:
   - Создать операцию списания из фабричного инвентаря
   - Создать операцию зачисления в основной инвентарь
   - Обе с типом "factory_return" и новым operation_id
4. Зафиксировать транзакцию
5. Сбросить кеш остатков для пользователя

**Выходные данные:**
- Успех/неуспех операции
- Количество возвращенных предметов

**Изменения в БД:**
- Добавление записей в `operations` (по 2 на каждый возвращаемый предмет)

#### Проверка статуса резервирования
```
GET /inventory/reservation/{operationID}
```

**Описание:** Проверяет существование и статус резервирования по ID операции. Используется для проверки целостности данных при восстановлении после сбоев.

**Входные параметры:**
- `operationID` - UUID операции резервирования (в пути запроса)

**Действия при вызове:**
1. Поиск операций резервирования по operation_id в таблице `operations`
2. Подсчет общего количества зарезервированных предметов
3. Проверка, что резерв не был потреблен или возвращен

**Выходные данные:**
```json
{
  "reservation_exists": true,
  "operation_id": "uuid",
  "user_id": "uuid", 
  "reserved_items": [
    {
      "item_code": "wood_plank",
      "collection_code": "basic",
      "quality_level_code": "common",
      "quantity": 5
    }
  ],
  "reservation_date": "2025-06-28T10:30:00Z",
  "status": "active"
}
```

**Возможные статусы:**
- `active` - резервирование активно
- `consumed` - резерв потреблен
- `returned` - резерв возвращен
- `not_found` - резервирование не найдено (404)

**Коды ответов:**
- `200` - резервирование найдено
- `404` - резервирование не существует
- `500` - внутренняя ошибка сервера

**Изменения в БД:** Нет (только чтение)

#### Потребление резерва
```
POST /inventory/consume-reserve
```

**Описание:** Уничтожает зарезервированные предметы при успешном завершении производства

**Входные параметры:**
- ID пользователя
- ID операции резервирования

**Действия при вызове:**
1. Найти все операции резервирования по operation_id в `operations`
2. Начать транзакцию БД
3. Для каждого зарезервированного предмета:
   - Создать операцию списания из фабричного инвентаря
   - Тип операции "factory_consumption"
   - Не создавать зачисление (предметы уничтожаются)
4. Зафиксировать транзакцию
5. Сбросить кеш остатков для пользователя

**Выходные данные:**
- Успех/неуспех операции
- Количество потребленных предметов

**Изменения в БД:**
- Добавление записей в `operations` (по 1 на каждый потребленный предмет)

#### Добавление предметов (для Game/Chest Service)
```
POST /inventory/add-items
```

**Описание:** Добавляет предметы в инвентарь пользователя (награды, покупки, результаты производства)

**Входные параметры:**
- ID пользователя
- Раздел инвентаря для добавления
- Тип операции (из классификатора)
- ID внешней операции (для связи с источником)
- Список предметов с количествами
- Комментарий (опционально)

**Действия при вызове:**
1. Преобразовать коды в UUID через `convertClassifierCodes(toUUID)`
2. Начать транзакцию БД
3. Подготовить массив операций для добавления
4. Вызвать `createOperationsInTransaction` для создания операций
5. Зафиксировать транзакцию

**Выходные данные:**
- Успех/неуспех операции
- ID созданных операций

**Изменения в БД:**
- Добавление записей в `operations` (по 1 на каждый предмет)
- Возможное создание/обновление записей в `daily_balances`

### Административные эндпоинты

#### Административные операции с инвентарем
```
POST /admin/inventory/adjust
```

**Описание:** Административная корректировка инвентаря для исправления ошибок или специальных операций

**Входные параметры:**
- ID пользователя
- Раздел инвентаря
- Список предметов с изменениями количества (могут быть отрицательными)
- Причина корректировки

**Действия при вызове:**
1. Проверить административные права доступа
2. Преобразовать коды в UUID через `convertClassifierCodes(toUUID)`
3. Для предметов с отрицательным изменением:
   - Вызвать `checkSufficientBalance` для проверки остатков
4. Начать транзакцию БД
5. Подготовить массив операций с типом "admin_adjustment"
6. Вызвать `createOperationsInTransaction` для создания операций
7. Зафиксировать транзакцию
8. Записать в аудит-лог детали операции

**Выходные данные:**
- Успех/неуспех операции
- Итоговые остатки после корректировки

**Изменения в БД:**
- Добавление записей в `operations` (по 1 на каждый предмет)
- Запись в аудит-лог

## Модель данных

### Основные сущности

#### Классификатор (Classifier)
- `id` - UUID классификатора
- `code` - код классификатора (item_class, item_type, quality_level, operation_type, collection, inventory_section)
- `description` - описание назначения классификатора
- `created_at` / `updated_at` - временные метки

#### Элемент классификатора (Classifier Item)
- `id` - UUID элемента
- `classifier_id` - ссылка на классификатор
- `code` - код элемента в рамках классификатора
- `description` - описание элемента
- `created_at` / `updated_at` - временные метки

#### Предмет (Item)
- `id` - UUID предмета
- `item_class_id` - ссылка на класс предмета из классификатора
- `item_type_id` - ссылка на тип предмета из классификатора
- `quality_levels_classifier_id` - ссылка на классификатор уровней качества
- `collections_classifier_id` - ссылка на классификатор коллекций
- `created_at` / `updated_at` - временные метки

*Примечание: названия и описания предметов хранятся отдельно в системе мультиязычности*

#### Изображения предметов (Item Images)
- `item_id` - UUID предмета
- `collection_id` - коллекция предмета из классификатора
- `quality_level_id` - уровень качества из классификатора
- `image_url` - URL изображения для данной комбинации

#### Дневные остатки (Daily Balances)
- `user_id` - UUID пользователя
- `section_id` - раздел инвентаря из классификатора
- `item_id` - UUID предмета
- `collection_id` - коллекция предмета из классификатора
- `quality_level_id` - уровень качества из классификатора
- `balance_date` - дата остатка (конец дня в UTC)
- `quantity` - количество предметов на конец дня

#### Операции (Operations)
- `id` - UUID операции
- `user_id` - UUID пользователя
- `section_id` - раздел инвентаря из классификатора
- `item_id` - UUID предмета
- `collection_id` - коллекция предмета из классификатора
- `quality_level_id` - уровень качества из классификатора
- `quantity_change` - изменение количества (+ поступление, - расход)
- `operation_type_id` - тип операции из классификатора
- `operation_id` - внешний UUID операции для связи с другими системами
- `recipe_id` - UUID рецепта (опционально)
- `comment` - комментарий к операции
- `created_at` - время выполнения операции

## Бизнес-логика

### Преобразование кодов классификаторов

**API принимает коды, БД хранит UUID:**
- Входящие запросы содержат коды классификаторов (`"winter"`, `"wooden"`, `"main"`)
- Сервис преобразует коды в UUID через поиск в таблицах классификаторов
- В БД операции сохраняются с UUID ссылками
- При возврате данных UUID преобразуются обратно в коды

**Обработка отсутствующих полей:**
- Отсутствие `collection` или `quality_level` в запросе означает стандартный вариант предмета
- Сервис использует специальное значение в БД для обозначения стандартного варианта
- При возврате данных стандартные варианты отображаются как отсутствующие поля

### Расчет текущих остатков

**Формула:** `Текущий остаток = Дневной остаток + Сумма операций за текущий день`

**Алгоритм:**
1. Найти дневной остаток на вчера (или последний доступный) для комбинации (user_id, section_id, item_id, collection_id, quality_level_id)
2. Найти все операции с начала текущего дня для той же комбинации
3. Сложить: дневной_остаток + сумма(quantity_change) = текущий остаток
4. Если дневного остатка нет - рассчитать его от предыдущего + операции и сохранить

**Создание дневных остатков (ленивое создание):**
- При расчете текущего остатка проверяется наличие дневного остатка за вчера
- Если остатка за вчера нет:
  - Находится последний существующий дневной остаток (может быть неделю назад)
  - Суммируются все операции от той даты до конца вчерашнего дня
  - Создается и сохраняется остаток только за вчерашний день
- Это гарантирует, что дневные остатки создаются только когда они действительно нужны

### Алгоритм резервирования

1. Рассчитать текущий остаток в основном инвентаре
2. Проверить достаточность предметов для резервирования  
3. В рамках одной транзакции:
   - Создать операцию списания из основного инвентаря
   - Создать операцию зачисления в фабричный инвентарь
   - Обе операции имеют тип factory_reservation и общий operation_id
4. Возврат результата операции (успех/ошибка с деталями)

### Валидация операций

- Проверка отрицательных остатков
- Валидация типов операций
- Проверка прав доступа к разделам инвентаря
- Атомарность всех операций в рамках транзакции

### Общие алгоритмы (переиспользуемые функции)

#### 1. Расчет текущего остатка (calculateCurrentBalance)
**Входные данные:**
- user_id, section_id, item_id, collection_id, quality_level_id

**Алгоритм:**
1. Проверить кеш Redis по ключу `inventory:{user_id}:{section_id}:{item_id}:{collection_id}:{quality_level_id}`
2. Если в кеше есть - вернуть значение
3. Если нет:
   - Найти последний дневной остаток из `daily_balances`
   - Если дневного остатка нет - вызвать `createDailyBalance` для его создания
   - Суммировать операции из `operations` от даты остатка до текущего момента
   - Вычислить: current = daily_balance + sum(quantity_change)
   - Сохранить в кеш на 1 час
4. Вернуть результат

#### 2. Создание дневного остатка (createDailyBalance)
**Входные данные:**
- user_id, section_id, item_id, collection_id, quality_level_id
- target_date (обычно вчерашняя дата)

**Алгоритм:**
1. Проверить, что остаток за target_date еще не существует
2. Найти последний существующий дневной остаток до target_date (может быть давно)
3. Если не найден - начальный остаток = 0
4. Суммировать ВСЕ операции от даты найденного остатка до конца target_date
5. Вычислить: new_balance = previous_balance + sum(operations)
6. Создать запись в `daily_balances` ТОЛЬКО для target_date
7. Вернуть созданный остаток

**Важно:** Создается остаток только за target_date, промежуточные дни НЕ заполняются

#### 3. Преобразование кодов классификаторов (convertClassifierCodes)
**Входные данные:**
- Объект с кодами классификаторов
- Направление: toUUID или fromUUID

**Алгоритм:**
1. Загрузить маппинг код<->UUID из кеша
2. Если нет в кеше - загрузить из БД и закешировать на 24 часа
3. Преобразовать все коды в UUID (или обратно)
4. Обработать отсутствующие поля как стандартные значения
5. Вернуть преобразованный объект

#### 4. Сброс кеша пользователя (invalidateUserCache)
**Входные данные:**
- user_id

**Алгоритм:**
1. Найти все ключи кеша по паттерну `inventory:{user_id}:*`
2. Удалить найденные ключи из Redis
3. Опционально: логировать количество удаленных ключей

#### 5. Проверка достаточности остатков (checkSufficientBalance)
**Входные данные:**
- user_id, section_id, список предметов с требуемыми количествами

**Алгоритм:**
1. Для каждого предмета:
   - Вызвать `calculateCurrentBalance`
   - Сравнить с требуемым количеством
   - Если недостаточно - добавить в список недостающих
2. Если список недостающих не пуст - вернуть ошибку с деталями
3. Иначе вернуть успех

#### 6. Создание операций в транзакции (createOperationsInTransaction)
**Входные данные:**
- Массив операций для создания
- Контекст транзакции БД

**Алгоритм:**
1. Валидировать все операции (quantity_change != 0)
2. Преобразовать коды классификаторов в UUID через `convertClassifierCodes`
3. Для каждой операции:
   - Установить created_at = now()
   - Вставить запись в `operations`
4. После успешной вставки всех операций - вызвать `invalidateUserCache`
5. Вернуть ID созданных операций

## Производительность

### Кеширование

- Справочные данные (классификаторы) кешируются в Redis на 24 часа
- Актуальные остатки инвентаря кешируются на 1 час
- Кеш остатков сбрасывается при любой операции изменения для конкретного пользователя

### Индексы БД

**Дневные остатки:**
- Первичный ключ: (user_id, section_id, item_id, collection_id, quality_level_id, balance_date)
- Индекс по balance_date для поиска остатков по дате
- Индекс по (user_id, balance_date) для остатков пользователя

**Операции:**
- Индекс по user_id для истории операций пользователя
- Индекс по (user_id, created_at) для операций пользователя по времени
- Составной индекс по (user_id, section_id, item_id, collection_id, quality_level_id, created_at) для операций с конкретным предметом
- Индекс по operation_type_id для аналитики операций
- Индекс по created_at для расчета дневных остатков

**Классификаторы:**
- Уникальный индекс по code для быстрого поиска классификатора
- Индекс по (classifier_id, code) для элементов классификатора

### Оптимизация запросов

- Пакетная обработка операций
- Ленивое создание дневных остатков
- Подготовленные запросы для частых операций

## Безопасность

### Аутентификация
- JWT токены от Auth Service
- Валидация токенов через Redis

### Авторизация
- Пользователи видят только свой инвентарь
- Внутренние эндпоинты доступны только другим сервисам
- Административные функции требуют специальных прав

### Валидация данных
- Строгая валидация всех входных параметров
- Проверка существования предметов и классификаторов
- Защита от SQL injection

## Мониторинг

### Метрики
- Количество операций по типам
- Время выполнения операций
- Использование кеша
- Количество активных пользователей

### Логирование
- Все операции с инвентарем
- Ошибки валидации
- Производительность запросов

## Зависимости

### Входящие зависимости
- Auth Service (проверка JWT токенов)

### Исходящие зависимости
- PostgreSQL 17 (основное хранилище)
- Redis 8.0.2 (кеширование и токены)

### Планируемые интеграции
- Factory Service (резервирование материалов)
- Trade Service (торговые операции)
- Game Service (награды и предметы)

## Справочные данные классификаторов

### Все классификаторы системы инвентаря

| Классификатор           | Код элемента        | Описание                                           |
| ----------------------- | ------------------- | -------------------------------------------------- |
| **item_class**          |                     | **Классы предметов в игре**                        |
|                         | resources           | Базовые ресурсы для строительства и производства   |
|                         | reagents            | Реагенты для производства инструментов             |
|                         | boosters            | Ускорители различных процессов                     |
|                         | blueprints          | Чертежи для производства инструментов              |
|                         | tools               | Инструменты для добычи ресурсов                    |
|                         | keys                | Ключи для открытия сундуков                        |
|                         | currencies          | Игровые валюты                                     |
| **quality_level**       |                     | **Уровни качества предметов**                      |
|                         | wooden              | Деревянный уровень                                 |
|                         | stone               | Каменный уровень                                   |
|                         | metal               | Металлический уровень                              |
|                         | diamond             | Бриллиантовый уровень                              |
|                         | small               | Малый размер (для ключей)                          |
|                         | medium              | Средний размер (для ключей)                        |
|                         | large               | Большой размер (для ключей)                        |
| **collection**          |                     | **Коллекции предметов (сезонные и базовые)**       |
|                         | winter_2025         | Зимняя коллекция 2025                              |
|                         | spring_2025         | Весенняя коллекция 2025                            |
|                         | summer_2025         | Летняя коллекция 2025                              |
|                         | autumn_2025         | Осенняя коллекция 2025                             |
| **inventory_section**   |                     | **Разделы инвентаря пользователя**                 |
|                         | main                | Основной инвентарь пользователя                    |
|                         | factory             | Фабричный инвентарь (зарезервированные материалы)  |
|                         | trade               | Торговый инвентарь (предметы на продаже)           |
| **operation_type**      |                     | **Типы операций с инвентарем**                     |
|                         | chest_reward        | Получение из сундука                               |
|                         | craft_result        | Результат производства                             |
|                         | trade_sale          | Продажа в торговле                                 |
|                         | trade_purchase      | Покупка в торговле                                 |
|                         | admin_adjustment    | Административная корректировка                     |
|                         | system_reward       | Системная награда                                  |
|                         | system_penalty      | Системное списание                                 |
|                         | daily_quest_reward  | Награда за ежедневное задание                      |
|                         | factory_reservation | Резервирование материалов для производства         |
|                         | factory_return      | Возврат материалов при отмене                      |
|                         | factory_consumption | Уничтожение материалов при производстве            |
|                         | trade_listing       | Размещение предмета на продажу                     |
|                         | trade_delisting     | Снятие предмета с продажи                          |
| **resource_type**       |                     | **Подтипы ресурсов для класса resources**          |
|                         | stone               | Камень                                             |
|                         | wood                | Дерево                                             |
|                         | ore                 | Руда                                               |
|                         | diamond             | Алмаз                                              |
| **reagent_type**        |                     | **Подтипы реагентов для класса reagents**          |
|                         | abrasive            | Абразив                                            |
|                         | disc                | Диск                                               |
|                         | inductor            | Индуктор                                           |
|                         | paste               | Паста                                              |
| **booster_type**        |                     | **Подтипы ускорителей для класса boosters**        |
|                         | repair_tool         | Починка инструмента                                |
|                         | speed_processing    | Ускорение переработки                              |
|                         | speed_crafting      | Ускорение создания                                 |
| **tool_type**           |                     | **Подтипы инструментов для класса tools**          |
|                         | shovel              | Лопата                                             |
|                         | sickle              | Серп                                               |
|                         | axe                 | Топор                                              |
|                         | pickaxe             | Кирка                                              |
| **key_type**            |                     | **Подтипы ключей для класса keys**                 |
|                         | key                 | Обычный ключ                                       |
|                         | blueprint_key       | Ключ для чертежей                                  |
| **currency_type**       |                     | **Подтипы валют для класса currencies**            |
|                         | diamonds            | Диаманты                                           |
| **tool_quality_levels** |                     | **Доступные уровни качества для инструментов**     |
|                         | wooden              | Деревянный инструмент                              |
|                         | stone               | Каменный инструмент                                |
|                         | metal               | Металлический инструмент                           |
|                         | diamond             | Бриллиантовый инструмент                           |
| **key_quality_levels**  |                     | **Доступные уровни качества для ключей**           |
|                         | small               | Малый ключ (Key-S)                                 |
|                         | medium              | Средний ключ (Key-M)                               |
|                         | large               | Большой ключ (Key-L)                               |
