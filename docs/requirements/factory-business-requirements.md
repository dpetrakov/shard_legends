# Бизнес-постановка: Система фабрики и производственных заданий

## Оглавление

1. [Общее описание](#общее-описание)
2. [Бизнес-цели](#бизнес-цели)
3. [Сущность "Фабрика"](#сущность-фабрика)
4. [Сущность "Производственное задание"](#сущность-производственное-задание)
5. [Система производственных слотов](#система-производственных-слотов)
6. [Система модификаторов](#система-модификаторов)
7. [Управление очередью производства](#управление-очередью-производства)
8. [Система Claim результатов](#система-claim-результатов)
9. [Бизнес-правила](#бизнес-правила)
10. [Требования к производительности](#требования-к-производительности)

---

## Общее описание

Система фабрики отвечает за исполнение производственных рецептов в контексте конкретного пользователя с учетом его инвентаря, характеристик персонажа и активных модификаторов. Фабрика принимает заказы на производство, проверяет наличие необходимых материалов, применяет модификаторы, создает производственные задания и управляет их выполнением в очереди производства пользователя.

## Сущность "Фабрика"

### Описание
Фабрика - это система обработки заказов на производство, которая принимает производственные рецепты и создает из них персонализированные производственные задания для конкретного пользователя.

### Функции фабрики

#### 1. Обработка заказа на производство
Фабрика принимает заказ, содержащий:
- **Пользователь** - для кого выполняется производство
- **Производственный рецепт** - базовый рецепт для исполнения
- **Количество исполнений** - сколько раз повторить рецепт
- **Ускорители** (необязательно) - предметы для модификации рецепта
- **Приоритет** (необязательно) - для определения порядка в очереди

#### 2. Валидация доступности материалов
- Проверка достаточности входных предметов в инвентаре пользователя
- Учет количества исполнений при проверке материалов
- Проверка доступности указанных ускорителей

#### 3. Применение модификаторов
Фабрика применяет модификаторы в следующем порядке приоритета:
1. **Модификаторы ускорителей** - эффекты от переданных предметов-ускорителей
2. **Пользовательские модификаторы** - VIP статус, уровень персонажа, достижения
3. **Событийные модификаторы** - сезонные бонусы, специальные события, временные акции

#### 4. Создание производственного задания
На основе модифицированного рецепта создается производственное задание с итоговыми параметрами.

---

## Сущность "Производственное задание"

### Описание
Производственное задание - это экземпляр производственного рецепта с примененными модификаторами, готовый к исполнению для конкретного пользователя.

### Атрибуты задания
- **Пользователь** - владелец задания
- **Базовый рецепт** - ссылка на исходный производственный рецепт
- **Входные предметы** - список материалов с количествами (может отличаться от базового рецепта)
- **Выходные предметы** - список возможных результатов с модифицированными вероятностями и количествами
- **Время производства** - итоговое время выполнения с учетом модификаторов
- **Класс операции** - категория производственного процесса для определения слота
- **Статус задания** - текущее состояние задания
- **Время создания** - когда задание было создано
- **Время начала производства** - когда начался процесс (если запущено)
- **Время окончания** - расчетное время завершения
- **Применённые модификаторы** - список модификаторов и их эффектов для аудита

### Статусы производственного задания
- **pending** - ожидает свободного слота для запуска
- **in_progress** - выполняется в производственном слоте
- **completed** - завершено, результат готов к Claim
- **claimed** - результат получен пользователем
- **cancelled** - отменено до начала выполнения
- **failed** - не удалось выполнить по техническим причинам

---

## Система производственных слотов

### Описание
Производственные слоты определяют сколько заданий пользователь может выполнять одновременно. Система основана на типах производственных слотов, каждый из которых может обрабатывать определенные классы операций.

### Классы операций
Каждый производственный рецепт относится к определенному классу операций:
- **crafting** - крафт инструментов, создание предметов
- **smelting** - переплавка, обработка сырья
- **chest_opening** - открытие сундуков
- **resource_gathering** - добыча ресурсов на месторождениях
- **special** - уникальные или событийные процессы

### Типы производственных слотов
Пользователю доступны различные типы слотов, каждый из которых специализируется на определенных классах операций:

#### Примеры типов слотов:
- **Универсальный слот** - может обрабатывать: crafting, smelting, chest_opening
- **Кузнечный слот** - может обрабатывать: crafting, smelting
- **Шахтерский слот** - может обрабатывать: resource_gathering
- **Специальный слот** - может обрабатывать: special

### Принципы работы слотов
- **Единая очередь пользователя** - все задания находятся в одной общей очереди
- **Автоматическое распределение** - при освобождении слота выбирается первое pending задание с подходящим классом операций
- **Возможность нулевых слотов** - у пользователя может не быть слотов для определенных классов операций

### Управление слотами
- **Количество и типы слотов** предоставляется сервисом управления пользователями
- **Динамическое выделение** - при освобождении слота система ищет первое подходящее задание в очереди
- **Ожидание в очереди** - задания могут ждать появления подходящего типа слота
- **Освобождение при завершении** - слот освобождается при переходе задания в статус "completed"

---

## Система модификаторов

### Типы модификаторов

#### 1. Модификаторы ускорителей
Эффекты от предметов-ускорителей, переданных в заказе:
- **Ускорение производства** - сокращение времени выполнения
- **Увеличение количества** - модификация диапазонов выходных предметов
- **Повышение шансов** - улучшение вероятностей получения редких предметов
- **Снижение затрат** - уменьшение количества требуемых материалов

#### 2. Пользовательские модификаторы
Постоянные или долгосрочные характеристики пользователя:
- **VIP статус** - процентные бонусы к скорости и качеству
- **Уровень персонажа** - градуальные улучшения характеристик
- **Достижения** - разблокированные постоянные бонусы
- **Клановые бонусы** - эффекты от членства в клане

#### 3. Событийные модификаторы
Временные модификаторы, активные в определенное время:
- **Сезонные бонусы** - эффекты в определенные игровые сезоны
- **Лунные циклы** - "в полнолуние шанс крафта выше на 5%"
- **Специальные события** - временные акции и праздники
- **Серверные буферы** - общие бонусы для всех игроков

### Применение модификаторов
- **Мультипликативное применение** - модификаторы применяются последовательно
- **Ограничения эффектов** - максимальные и минимальные значения для предотвращения дисбаланса
- **Приоритет применения** - ускорители → пользовательские → событийные
- **Логирование изменений** - сохранение информации о примененных модификаторах

---

## Система фабричного склада

### Описание
Фабричный склад - это специальный раздел инвентаря пользователя, предназначенный для хранения материалов и ускорителей, зарезервированных для производственных заданий. Этот раздел изолирован от основного инвентаря и недоступен пользователю напрямую.

### Разделы инвентаря
В системе существуют следующие разделы инвентаря:
- **Базовый инвентарь** - основной раздел, видимый и доступный пользователю через интерфейс
- **Фабричный инвентарь** - служебный раздел для хранения зарезервированных материалов
- **Торговый инвентарь** (планируется) - раздел для предметов, выставленных на продажу

### Принципы работы фабричного склада
- **Изоляция ресурсов** - предметы на фабричном складе недоступны для других операций
- **Отдельный учет остатков** - остатки ведутся раздельно для каждого раздела инвентаря
- **Полное протоколирование** - все операции перемещения между разделами фиксируются в протоколе
- **Атомарность операций** - перемещение материалов и управление заданиями происходит в одной транзакции

### Операции с фабричным складом

#### 1. Резервирование материалов (при создании задания)
- **Валидация наличия** - проверка достаточности материалов в базовом инвентаре
- **Атомарное перемещение** - одновременный перевод материалов и создание задания
- **Протоколирование** - запись операций типа "factory_reservation" в протокол
- **Изоляция ресурсов** - материалы становятся недоступными для других операций

#### 2. Возврат материалов (при отмене задания)
- **Атомарная отмена** - одновременное удаление задания и возврат материалов
- **Полный возврат** - все зарезервированные материалы возвращаются в базовый инвентарь
- **Протоколирование** - запись операций типа "factory_return" в протокол
- **Восстановление доступности** - материалы снова становятся доступными пользователю

#### 3. Уничтожение материалов (при успешном Claim)
- **Атомарный Claim** - одновременное зачисление результата и уничтожение материалов
- **Окончательное удаление** - материалы навсегда удаляются из фабричного инвентаря
- **Протоколирование** - запись операций типа "factory_consumption" в протокол
- **Завершение цикла** - освобождение записей на фабричном складе

### Типы операций в протоколе
- **factory_reservation** - резервирование материалов при создании задания
- **factory_return** - возврат материалов при отмене задания
- **factory_consumption** - уничтожение материалов при успешном Claim
- **factory_transfer** - служебные операции перемещения (при необходимости)

---

## Управление очередью производства

### Принципы очереди
- **Единая очередь пользователя** - все задания находятся в одной общей очереди независимо от класса операций
- **Строгий FIFO** - задания всегда добавляются в хвост очереди и выполняются в порядке времени создания
- **Простота управления** - для изменения порядка пользователь отменяет задания и создает заново в нужной последовательности
- **Ленивый расчет статусов** - статусы заданий обновляются только при запросе информации о очереди

### Добавление в очередь
1. **Валидация ресурсов** - проверка наличия материалов и ускорителей в базовом инвентаре
2. **Расчет результата** - генерация финального результата с учетом всех модификаторов
3. **Атомарная операция резервирования** - одновременное создание задания и перемещение материалов из базового инвентаря в фабричный
4. **Протоколирование резервирования** - запись операций типа "factory_reservation" для всех перемещенных материалов
5. **Постановка в хвост очереди** - все новые задания всегда добавляются в конец очереди
6. **Проверка доступности слотов** - поиск свободного слота, поддерживающего класс операций задания
7. **Немедленный запуск или ожидание** - если подходящий слот свободен, задание сразу переходит в статус "in_progress", иначе остается в статусе "pending"

### Организация очереди
- **Пакетное создание** - можно создать несколько заданий одного рецепта за раз
- **Смешанные рецепты** - в очереди могут находиться задания разных рецептов
- **Порядок по времени** - очередность определяется исключительно временем создания задания
- **Отмена и пересоздание** - для изменения порядка пользователь отменяет ненужные задания и создает новые

### Система выделения слотов
При освобождении производственного слота система автоматически ищет следующее задание для запуска:

#### Алгоритм выделения слота:
1. **Определение типа освободившегося слота** - какие классы операций он может обрабатывать
2. **Поиск в единой очереди** - последовательный просмотр всех pending заданий по времени создания
3. **Проверка совместимости** - сравнение класса операций задания со списком поддерживаемых слотом
4. **Выбор первого подходящего** - запуск первого найденного совместимого задания
5. **Обновление статуса** - перевод задания в статус "in_progress"

#### Особенности работы:
- **Могут пропускаться задания** - если в очереди есть задания с неподдерживаемыми классами операций
- **Справедливое распределение** - в рамках совместимых классов соблюдается строгий FIFO
- **Ожидание появления слотов** - задания могут долго ждать, если у пользователя нет подходящих слотов
- **Эффективное использование** - любой освободившийся слот сразу занимается подходящим заданием

---

## Система Claim результатов

### Принцип работы
После завершения производственного задания результат не попадает в инвентарь автоматически - пользователь должен выполнить действие Claim для получения предметов.

### Процесс Claim
1. **Просмотр результатов** - пользователь может увидеть что именно было произведено
2. **Выполнение Claim** - подтверждение получения результатов
3. **Зачисление в инвентарь** - предметы добавляются в инвентарь пользователя

### Особенности системы Claim
- **Обязательность действия** - без Claim предметы остаются "подвешенными"
- **Отсутствие временных ограничений** - Claim можно выполнить в любое время
- **Пакетный Claim** - можно забрать результаты всех заданий одновременно
- **Аудит получения** - все Claim операции логируются в протоколе операций с предметами

---

## Бизнес-правила

### Правила создания заданий
1. **Активность рецепта** - можно использовать только активные рецепты
2. **Предрасчет результата** - результат производства определяется в момент создания задания

### Правила фабричного склада
1. **Атомарное резервирование** - перемещение материалов из базового инвентаря в фабричный и создание задания происходит в одной транзакции
2. **Изоляция ресурсов** - материалы в фабричном инвентаре недоступны для других операций
3. **Протоколирование перемещений** - все операции между разделами инвентаря фиксируются в протоколе
4. **Атомарная отмена** - отмена задания и возврат материалов в базовый инвентарь происходит в одной транзакции
5. **Атомарный Claim** - зачисление результата в базовый инвентарь и уничтожение материалов в фабричном происходит в одной транзакции

### Правила выполнения заданий
1. **Ленивое обновление статусов** - статусы заданий обновляются только при запросе информации о очереди
2. **Неизменность запущенных заданий** - задания в статусе "in_progress" нельзя изменить или отменить
3. **Освобождение слотов** - слот освобождается при переходе задания в статус "completed"
4. **Автоматический запуск** - следующее задание из очереди запускается при освобождении совместимого слота

### Правила очереди и слотов
1. **Единая очередь** - все задания находятся в одной общей очереди независимо от класса операций
2. **Строгий порядок** - задания выполняются строго в порядке времени создания (FIFO)
3. **Совместимость слотов** - задание может запуститься только в слоте, поддерживающем его класс операций
4. **Автоматическое выделение** - при освобождении слота запускается первое совместимое pending задание
5. **Возможность ожидания** - задания могут оставаться в очереди, если нет подходящих слотов
6. **Отмена из очереди** - задания в статусе "pending" можно отменить с возвратом материалов
7. **Эксклюзивность классов** - каждый класс операций обрабатывается только одним типом слотов

### Правила Claim
1. **Скрытность результатов** - результат производства неизвестен до момента выполнения Claim
2. **Обязательность Claim** - результаты попадают в инвентарь только после явного действия пользователя
3. **Атомарность операции** - Claim включает зачисление результата в базовый инвентарь и уничтожение материалов в фабричном инвентаре
4. **Неповторимость Claim** - одно задание можно забрать только один раз
5. **Протоколирование** - все Claim операции записываются в лог операций с предметами
