# Бизнес-постановка: Система производственных рецептов

## Оглавление

1. [Общее описание](#общее-описание)
2. [Бизнес-цели](#бизнес-цели)
3. [Сущность "Производственные рецепты"](#сущность-производственные-рецепты)
4. [Типы производственных процессов](#типы-производственных-процессов)
5. [Система входных и выходных предметов](#система-входных-и-выходных-предметов)
6. [Система вероятностей и выбора результата](#система-вероятностей-и-выбора-результата)
7. [Временные ограничения и лимиты](#временные-ограничения-и-лимиты)
8. [Управление активностью рецептов](#управление-активностью-рецептов)
9. [Бизнес-правила](#бизнес-правила)
10. [Требования к производительности](#требования-к-производительности)

---

## Общее описание

Система производственных рецептов определяет все возможные способы создания, получения и преобразования предметов в игре (кроме покупки через маркетплейсы в будущем). Рецепты являются статической конфигурацией, которая задается командой разработки на этапе дизайна системы и может изменяться для балансировки игровой экономики. Они определяют только базовые параметры и не зависят от характеристик конкретного пользователя.

Система должна охватывать все процессы возникновения предметов: получение сундуков из мини-игры "Дека", содержимое сундуков, переплавку сырья в кузнице, крафт инструментов, получение ключей и любые другие игровые механики создания предметов.

---

## Сущность "Производственные рецепты"

### Описание
Производственный рецепт - это статическая конфигурация, определяющая базовые правила преобразования входных предметов (или их отсутствия) в выходные предметы. Рецепты не содержат пользовательских модификаторов - все динамические изменения применяются во время выполнения.

### Основные атрибуты
- **Название рецепта** - уникальное имя для идентификации
- **Класс операции** - категория производственного процесса для определения слота в фабрике 
- **Описание** - текстовое описание процесса
- **Активность** - доступен ли рецепт для использования
- **Время производства** - длительность выполнения рецепта
- **Лимиты использования** - гибкие ограничения на количество использований в различных временных окнах

---

## Универсальный производственный процесс

Все способы создания, получения и преобразования предметов в игре описываются единым универсальным производственным рецептом. Каждый рецепт определяет:

### Основная структура рецепта

**Входные предметы (материалы)**:
- Могут отсутствовать (для процессов "создания из ничего")
- Могут состоять из одного или нескольких предметов в разных количествах

**Выходные предметы (результаты)**:
- Организованы в группы (альтернативные, опциональные)
- Каждый предмет имеет вероятность и диапазон количества

**Модификации коллекций**:
- Правила передачи коллекций от входных предметов к выходным
- Возможность явного указания коллекций для результатов

**Ограничения и лимиты**:
- Время выполнения (от мгновенного до нескольких часов)
- Лимиты использования с разными типами временных окон (всего, в день, в месяц, в сезон и т.д.)

### Примеры конфигурации рецептов

**Получение сундуков**:
- Вход: ничего
- Выход: сундуки с разными вероятностями и количеством
- Лимиты: базовый лимит 10 в день

**Открытие сундуков**:
- Вход: сундук + ключ
- Выход: ресурсы/реагенты/ускорители/чертежи
- Модификации: коллекция ключа может передаваться некоторым предметам

**Переплавка в кузнице**:
- Вход: 100 сырья + 4 реагента
- Выход: 1 заготовка (гарантированно)
- Время: 1 час

**Крафт инструментов**:
- Вход: 1 чертеж + 4 заготовки
- Выход: 1 инструмент (гарантированно)
- Модификации: инструмент наследует коллекцию чертежа
- Время: 12 часов

**Получение ключей**:
- Вход: ничего
- Выход: 1 ключ случайного типа
- Лимиты: 1 раз в неделю

**Системные награды**:
- Вход: ничего
- Выход: любые предметы в любых количествах
- Модификации: возможность явного указания коллекций

---

## Система входных и выходных предметов

### Входные предметы (материалы)
Рецепт может требовать:
- **Отсутствие входных предметов** - для процессов "создания из ничего"
- **Один предмет** - для простых преобразований
- **Несколько предметов** - для сложных рецептов

**Атрибуты входного предмета**:
- **Предмет** - ссылка на предмет из справочника
- **Количество** - требуемое количество предмета (обязательное базовое значение)

### Выходные предметы (результаты)
Рецепт может создавать:
- **Один гарантированный предмет** - для детерминированных процессов
- **Несколько альтернативных предметов** - с различными вероятностями
- **Комбинацию предметов** - несколько предметов одновременно

**Атрибуты выходного предмета**:
- **Предмет** - ссылка на создаваемый предмет
- **Минимальное количество** - наименьшее количество при выпадении
- **Максимальное количество** - наибольшее количество при выпадении
- **Вероятность** - шанс получения этого предмета (в процентах)
- **Группа** - принадлежность к группе взаимоисключающих предметов
- **Источник коллекции** - от какого входного предмета наследовать коллекцию (необязательно)
- **Источник качества** - от какого входного предмета наследовать качество (необязательно)
- **Фиксированная коллекция** - явно указанная коллекция (альтернатива наследованию)
- **Фиксированное качество** - явно указанное качество (альтернатива наследованию)

### Группировка выходных предметов
Выходные предметы могут быть обработаны двумя способами:

### Способ 1: Альтернативные группы
Предметы объединяются в группы, где выбирается один предмет или ни одного:
- **Если сумма вероятностей = 100%** - гарантированно выпадает один предмет
- **Если сумма вероятностей < 100%** - есть шанс не получить ничего (например, 60% + 30% = 90%, значит 10% шанс пустого результата)
- **Если сумма вероятностей > 100%** - вероятности нормируются до 100%

### Способ 2: Индивидуальная обработка
Предметы без указания группы обрабатываются индивидуально - каждый предмет проверяется на выпадение согласно своей вероятности.

**Примеры обработки**:
- Группа 1 (альтернативная, 100%): Предмет Y с вероятностью 80% ИЛИ Предмет Z с вероятностью 20% (гарантированно выпадет один)
- Группа 2 (альтернативная, 50%): Предмет A с вероятностью 30% ИЛИ Предмет B с вероятностью 20% (50% шанс ничего не получить)
- Без группы: Предмет X с вероятностью 100% (гарантированно выпадает)

### Наследование коллекций и качества
Для каждого выходного предмета можно определить откуда брать коллекцию и качество:

**Способы определения коллекции**:
1. **Наследование от материала** - указать входной предмет как источник коллекции
2. **Конкретная коллекция** - указать идентификатор конкретной коллекции (например: "autumn-2025")
3. **Текущий сезон** - использовать ключевое слово "CURRENT_SEASON" для автоматической постановки актуальной сезонной коллекции
4. **Базовая коллекция** - если коллекция не указана, используется стандартная коллекция предмета

**Способы определения качества**:
1. **Наследование от материала** - указать входной предмет как источник качества
2. **Фиксированное качество** - явно указать конкретный уровень качества
3. **Базовое качество** - если качество не указано, используется стандартное качество предмета (определенное в справочнике предметов)

**Примеры работы с коллекциями**:
- При крафте инструмента: наследует коллекцию от чертежа, качество от заготовок
- При открытии сундуков: коллекция не указана - используется базовая
- При создании чертежей: коллекция = "CURRENT_SEASON" (автоматически подставляется актуальная сезонная)
- При системных наградах: коллекция = "event-winter-2025" (конкретная событийная коллекция)

---

## Система вероятностей и выбора результата

### Алгоритм выбора результата
1. **Обработка альтернативных групп** - случайный выбор на основе вероятностей (с учетом возможности пустого результата)
2. **Обработка индивидуальных предметов** - проверка вероятности для каждого предмета без группы
3. **Определение количества** - случайное целое число в диапазоне от минимального до максимального

### Правила валидации вероятностей
- **Альтернативные группы**: 
  - Если сумма > 100% - вероятности нормируются пропорционально до 100%
  - Если сумма <= 100% - вероятности используются как есть, оставшаяся часть - шанс не получить ничего
- **Индивидуальные предметы**: вероятность может быть любой от 0% до 100%

### Модификаторы во время выполнения
Рецепты определяют только базовые вероятности, количества и лимиты. Все модификаторы применяются только во время запуска процесса производства:

- **Пользовательские модификаторы** - статус пользователя, достижения, навыки
- **Примененные усилители** - временные бонусы, активные эффекты
- **Событийные модификаторы** - активные события, промоакции, сезонные бонусы

### Приоритет модификаций
Модификации применяются в порядке приоритета:
1. **Явно указанная коллекция** - конкретная коллекция в модификации
2. **Наследование от входных предметов** - передача коллекции от материалов
3. **Базовая коллекция** - использование стандартной коллекции предмета

### Особые случаи
- **Фиксированное количество** - когда минимальное и максимальное количество совпадают
- **Нулевое количество** - когда минимальное количество равно 0 (предмет может не выпасть)
- **Множественные группы** - рецепт может содержать произвольное количество групп всех типов

---

## Лимиты

### Лимиты использования
Рецепты определяют только базовые лимиты. Итоговые лимиты для конкретного пользователя рассчитываются во время запуска с учетом всех модификаторов.

### Структура лимита
Каждый лимит состоит из:
- **Объект лимита** - что ограничивается (запуск рецепта или получение конкретного предмета)
- **Количество** - максимальное количество использований
- **Тип лимита** - временное окно для подсчета использований

### Объекты лимитов
- **Запуск рецепта** - ограничение на количество запусков рецепта
- **Получение предмета** - ограничение на количество успешных получений определенного предмета (указывается конкретный предмет)

### Типы лимитов
Тип лимита определяется справочником и контролируется производственным процессом:

**Основные типы**:
- **Всего** - общий лимит на все время жизни профиля
- **В день** - лимит на календарные сутки (00:00-23:59 UTC)
- **В неделю** - лимит на календарную неделю (понедельник-воскресенье)
- **В календарный месяц** - лимит на календарный месяц (1-е число до последнего числа)
- **В квартал** - лимит на квартал (3 месяца)
- **В год** - лимит на календарный год

**Игровые типы**:
- **В сезон** - лимит на сезон (4 недели для чертежей)
- **За событие** - лимит на все время проведения события

### Примеры лимитов
**Лимиты на запуск рецепта**:
- Получение сундуков: 10 запусков в день
- Получение ключей: 1 запуск в неделю
- Переплавка в кузнице: неограниченно

**Лимиты на получение предмета**:
- Специальные чертежи Blueprint: 5 штук в сезон
- Успешные трансформации дерева в алмазы: 3 в неделю
- Премиум награды: 1 всего

### Учет использований
- **Для лимитов на запуск** - считается каждый запуск рецепта
- **Для лимитов на получение** - считается только успешное получение указанного предмета (например, если в альтернативной группе выпал другой предмет, лимит не учитывается)

---

## Управление активностью рецептов

### Статусы активности
- **Активный** - рецепт доступен для использования
- **Неактивный** - рецепт временно недоступен
- **Архивный** - рецепт окончательно выведен из использования
- **Тестовый** - рецепт доступен только в тестовой среде

### Причины изменения активности
- **Сезонные изменения** - смена сезонов для чертежей Blueprint
- **Балансировка** - временное отключение для настройки экономики
- **События** - специальные рецепты для ограниченных по времени активностей
- **Технические работы** - отключение при обновлениях
