# Бизнес-постановка: Система предметов и инвентаря пользователя

## Оглавление

1. [Общее описание](#общее-описание)
2. [Бизнес-цели](#бизнес-цели)
3. [Сущность "Предметы"](#сущность-предметы)
4. [Сущность "Инвентарь пользователя"](#сущность-инвентарь-пользователя)
5. [Система учета остатков](#система-учета-остатков)
6. [Протоколирование операций](#протоколирование-операций)
7. [Бизнес-правила](#бизнес-правила)
8. [Требования к производительности](#требования-к-производительности)

---

## Общее описание

Система предметов и инвентаря обеспечивает управление игровыми предметами, их хранение в инвентаре пользователей и учет всех операций с предметами. Система должна поддерживать получение предметов из сундуков, использование предметов в игровых процессах и торговлю между игроками.

## Сущность "Предметы"

### Описание
Предметы представляют собой все игровые объекты, которые могут находиться в инвентаре пользователя.

### Структура классификации

> **Примечание**: Приведенная ниже структура классификации является примером и настройкой системы. Классы, типы и уровни качества могут изменяться в процессе разработки и балансировки игры.

**Класс предмета** - высший уровень группировки:
- Ресурсы
- Реагенты  
- Ускорители
- Чертежи (Blueprint)
- Инструменты
- Ключи
- Валюты (аналоги денег: Диамонды и др.)

**Тип предмета** - детализация внутри класса:
- Для ресурсов: Камень, Дерево, Руда, Алмаз
- Для реагентов: Абразив, Диск, Индуктор, Паста
- Для ускорителей: Починка инструмента, Ускорение переработки, Ускорение создания
- Для чертежей: Лопата, Серп, Топор, Кирка
- Для инструментов: Лопата, Серп, Топор, Кирка
- Для ключей: Ключ, Чертежный ключей
- Для валют: Диамонды (премиум валюта)

**Уровень качества** - градация предмета по ценности и редкости:
- Для ресурсов и реагентов: Базовый (единственный уровень)
- Для ускорителей: Базовый (единственный уровень)
- Для чертежей: Базовый (единственный уровень)
- Для инструментов: Деревянный, Каменный, Металлический, Бриллиантовый
- Для ключей: Малый (Key-S), Средний (Key-M), Большой (Key-L), 
- Для Чертежных ключей: Базовый (единственный уровень)
- Для валют: Базовый (единственный уровень)

**Коллекция** - сезонная или тематическая группировка:
- Для чертежей: определяется сезоном (4-недельные циклы)
- Для инструментов: может варьироваться по сезонам для создания коллекционных серий
- Для всех остальных классов: базовая коллекция
- **Базовая коллекция**: всегда существует для каждого класса предметов как основная версия
- **Текущая сезонная коллекция**: одна из коллекций каждого вида объекта помечается как актуальная сезонная (для чертежей и инструментов)

### Атрибуты предмета
- **Название** - отображаемое имя предмета
- **Описание** - текстовое описание функций и свойств
- **Изображение** - ссылка на графический файл
- **Класс** - принадлежность к классу предметов
- **Тип** - конкретный тип внутри класса
- **Уровень качества** - градация по ценности и редкости
- **Коллекция** - принадлежность к коллекции

---

## Сущность "Инвентарь пользователя"

### Описание
Инвентарь представляет совокупность всех предметов, принадлежащих конкретному пользователю. Инвентарь не имеет ограничений по объему или типам предметов.

### Принципы работы
- **Неограниченность** - в инвентаре может находиться любое количество любых предметов
- **Агрегация** - одинаковые предметы хранятся как количество, а не отдельными экземплярами
- **Целочисленность** - все количества предметов и валют являются целыми числами
- **Историчность** - все изменения фиксируются в протоколе операций
- **Консистентность** - остатки рассчитываются на основе дневных срезов и операций

### Типы хранения предметов
- **Агрегированные предметы** - стандартные предметы, которые группируются по типу+коллекция+качество и хранятся как количество
- **Уникальные предметы** (планируется на будущее) - предметы с индивидуальными характеристиками (аналоги NFT), которые не агрегируются и хранятся отдельно. На данном этапе проекта не планируется к реализации, но архитектура должна учитывать возможность их добавления.

### Состав инвентаря
Инвентарь состоит из записей вида:
- **Пользователь** - владелец инвентаря
- **Предмет** - какой предмет хранится
- **Коллекция** - к какой коллекции относится предмет
- **Уровень качества** - уровень качества предмета
- **Текущий остаток** - количество предметов на текущий момент

### Принцип учета остатков
Остатки в инвентаре ведутся раздельно для каждой уникальной комбинации:
- **Предмет + Коллекция + Уровень качества**

Например:
- "Топор деревянный базовой коллекции" и "Топор деревянный сезонной коллекции Весна-2025" - это разные позиции в инвентаре
- "Ключ малый" и "Ключ средний" - это разные позиции в инвентаре

---

## Система учета остатков

### Принцип дневных остатков
Система работает на основе ежедневных снимков остатков по состоянию на конец дня (00:00 UTC).

### Расчет текущего остатка
**Формула**: `Текущий остаток = Дневной остаток + Сумма операций за текущий день`

Где:
- **Дневной остаток** - зафиксированное количество предмета на конец предыдущего дня
- **Сумма операций** - алгебраическая сумма всех операций с предметом с начала текущего дня

### Создание дневных остатков
Дневные остатки создаются автоматически **По запросу** - если при расчете текущего остатка отсутствует дневной остаток

Если дневного остатка нет, система ищет последний доступный дневной остаток, применяет к нему все операции до нужной даты и сохраняет результат как дневной остаток.

---

## Протоколирование операций

### Обязательность протоколирования
Все изменения количества предметов в инвентаре должны сопровождаться записью в протоколе операций.

### Атрибуты операции
- **Пользователь** - чей инвентарь изменяется
- **Предмет** - какой предмет затронут операцией
- **Коллекция** - коллекция предмета
- **Уровень качества** - уровень качества предмета
- **Изменение количества** - положительное (поступление) или отрицательное (расход) число
- **Тип операции** - категория операции (получение из сундука, использование в крафте, торговля и т.д.)
- **Идентификатор операции** - уникальный ID операции для связи с другими системами
- **Идентификатор рецепта** - ссылка на производственный рецепт (необязательное поле для контроля лимитов использования)
- **Комментарий** - дополнительная информация об операции
- **Время операции** - точное время выполнения операции

### Типы операций
- **chest_reward** - получение из сундука
- **craft_consumption** - использование в крафте
- **craft_result** - результат крафта
- **trade_sale** - продажа в торговле
- **trade_purchase** - покупка в торговле
- **admin_adjustment** - административная корректировка
- **system_reward** - системная награда
- **system_penalty** - системное списание

---

## Бизнес-правила

### Правила операций
1. **Запрет отрицательных остатков** - нельзя расходовать больше предметов, чем есть в инвентаре
2. **Атомарность операций** - операция либо выполняется полностью, либо не выполняется вообще
3. **Обязательное обоснование** - каждая операция должна иметь тип и идентификатор

### Правила предметов
1. **Уникальность в коллекции** - в рамках одной коллекции не может быть предметов с одинаковыми названиями
2. **Неизменность истории** - записи в протоколе операций не подлежат изменению или удалению

### Правила дневных остатков
1. **Фиксация в UTC** - все дневные остатки фиксируются по времени UTC
2. **Неизменность** - дневные остатки не подлежат изменению после создания
3. **Обязательность расчета** - при отсутствии дневного остатка он должен быть рассчитан и сохранен
