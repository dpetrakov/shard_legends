# Бизнес-постановка: Система предметов и инвентаря пользователя

## Оглавление

1. [Общее описание](#общее-описание)
2. [Бизнес-цели](#бизнес-цели)
3. [Сущность "Предметы"](#сущность-предметы)
4. [Сущность "Инвентарь пользователя"](#сущность-инвентарь-пользователя)
5. [Система учета остатков](#система-учета-остатков)
6. [Протоколирование операций](#протоколирование-операций)
7. [Бизнес-правила](#бизнес-правила)
8. [Требования к производительности](#требования-к-производительности)

---

## Общее описание

Система предметов и инвентаря обеспечивает управление игровыми предметами, их хранение в инвентаре пользователей и учет всех операций с предметами. Система должна поддерживать получение предметов из сундуков, использование предметов в игровых процессах и торговлю между игроками.

## Сущность "Предметы"

### Описание
Предметы представляют собой все игровые объекты, которые могут находиться в инвентаре пользователя.

### Структура классификации

> **Примечание**: Приведенная ниже структура классификации является примером и настройкой системы. Классы, типы и уровни качества могут изменяться в процессе разработки и балансировки игры.

**Класс предмета** - высший уровень группировки:
- Ресурсы
- Реагенты  
- Ускорители
- Чертежи (Blueprint)
- Инструменты
- Ключи
- Валюты (аналоги денег: Диамонды и др.)

**Тип предмета** - детализация внутри класса:
- Для ресурсов: Камень, Дерево, Руда, Алмаз
- Для реагентов: Абразив, Диск, Индуктор, Паста
- Для ускорителей: Починка инструмента, Ускорение переработки, Ускорение создания
- Для чертежей: Лопата, Серп, Топор, Кирка
- Для инструментов: Лопата, Серп, Топор, Кирка
- Для ключей: Ключ, Чертежный ключей
- Для валют: Диамонды (премиум валюта)

**Уровень качества** - градация предмета по ценности и редкости:
- Для ресурсов и реагентов: Базовый (единственный уровень)
- Для ускорителей: Базовый (единственный уровень)
- Для чертежей: Базовый (единственный уровень)
- Для инструментов: Деревянный, Каменный, Металлический, Бриллиантовый
- Для ключей: Малый (Key-S), Средний (Key-M), Большой (Key-L), 
- Для Чертежных ключей: Базовый (единственный уровень)
- Для валют: Базовый (единственный уровень)

**Коллекция** - сезонная или тематическая группировка:
- Для чертежей: определяется сезоном (4-недельные циклы)
- Для инструментов: может варьироваться по сезонам для создания коллекционных серий
- Для всех остальных классов: базовая коллекция
- **Базовая коллекция**: всегда существует для каждого класса предметов как основная версия
- **Текущая сезонная коллекция**: одна из коллекций каждого вида объекта помечается как актуальная сезонная (для чертежей и инструментов)

### Атрибуты предмета
- **Название** - отображаемое имя предмета
- **Описание** - текстовое описание функций и свойств
- **Изображение** - ссылка на графический файл
- **Класс** - принадлежность к классу предметов
- **Тип** - конкретный тип внутри класса
- **Уровень качества** - градация по ценности и редкости
- **Коллекция** - принадлежность к коллекции

---

## Сущность "Инвентарь пользователя"

### Описание
Инвентарь представляет совокупность всех предметов, принадлежащих конкретному пользователю, организованных в несколько изолированных разделов. Каждый раздел имеет свою область применения и ограничения доступа.

### Разделы инвентаря
Инвентарь пользователя состоит из следующих разделов:

#### 1. Базовый инвентарь
- **Назначение** - основной раздел для хранения предметов пользователя
- **Доступность** - полностью видимый и доступный пользователю через интерфейс
- **Операции** - все стандартные операции с предметами (использование, передача и т.д.)
- **Отображение** - отображается в основном интерфейсе инвентаря

#### 2. Фабричный инвентарь
- **Назначение** - служебный раздел для хранения материалов, зарезервированных для производственных заданий
- **Доступность** - недоступен пользователю напрямую, управляется системой фабрики
- **Операции** - только системные операции резервирования, возврата и уничтожения
- **Изоляция** - предметы недоступны для других операций

#### 3. Торговый инвентарь (планируется)
- **Назначение** - раздел для предметов, выставленных на продажу
- **Доступность** - видимый пользователю, но с ограниченными операциями
- **Операции** - снятие с продажи, изменение цены
- **Изоляция** - предметы недоступны для использования до снятия с продажи

### Принципы работы инвентаря
- **Изоляция разделов** - предметы в разных разделах учитываются раздельно и не пересекаются
- **Раздельный учет остатков** - остатки ведутся отдельно для каждого раздела инвентаря
- **Агрегация** - одинаковые предметы хранятся как количество, а не отдельными экземплярами
- **Целочисленность** - все количества предметов и валют являются целыми числами
- **Полное протоколирование** - все операции, включая перемещения между разделами, фиксируются в протоколе
- **Атомарность переходов** - перемещение предметов между разделами происходит в рамках одной транзакции

### Типы хранения предметов
- **Агрегированные предметы** - стандартные предметы, которые группируются по типу+коллекция+качество и хранятся как количество
- **Уникальные предметы** (планируется на будущее) - предметы с индивидуальными характеристиками (аналоги NFT), которые не агрегируются и хранятся отдельно. На данном этапе проекта не планируется к реализации, но архитектура должна учитывать возможность их добавления.

### Состав инвентаря
Каждый раздел инвентаря состоит из записей вида:
- **Пользователь** - владелец инвентаря
- **Раздел инвентаря** - базовый, фабричный или торговый
- **Предмет** - какой предмет хранится
- **Коллекция** - к какой коллекции относится предмет
- **Уровень качества** - уровень качества предмета
- **Текущий остаток** - количество предметов в данном разделе на текущий момент

### Принцип учета остатков
Остатки в инвентаре ведутся раздельно для каждой уникальной комбинации:
- **Раздел + Предмет + Коллекция + Уровень качества**

Например:
- "Базовый инвентарь: Топор деревянный базовой коллекции" и "Фабричный инвентарь: Топор деревянный базовой коллекции" - это разные позиции
- "Базовый инвентарь: Ключ малый" и "Базовый инвентарь: Ключ средний" - это разные позиции
- Один и тот же предмет может одновременно находиться в разных разделах инвентаря

### Операции между разделами инвентаря
Система поддерживает следующие типы операций перемещения:
- **factory_reservation** - перемещение из базового в фабричный инвентарь при создании производственного задания
- **factory_return** - возврат из фабричного в базовый инвентарь при отмене задания
- **factory_consumption** - уничтожение из фабричного инвентаря при успешном Claim
- **trade_listing** (планируется) - перемещение из базового в торговый инвентарь
- **trade_delisting** (планируется) - возврат из торгового в базовый инвентарь

---

## Система учета остатков

### Принцип дневных остатков
Система работает на основе ежедневных снимков остатков по состоянию на конец дня (00:00 UTC).

### Расчет текущего остатка
**Формула**: `Текущий остаток = Дневной остаток + Сумма операций за текущий день`

Где:
- **Дневной остаток** - зафиксированное количество предмета на конец предыдущего дня
- **Сумма операций** - алгебраическая сумма всех операций с предметом с начала текущего дня

### Создание дневных остатков
Дневные остатки создаются автоматически **По запросу** - если при расчете текущего остатка отсутствует дневной остаток

Если дневного остатка нет, система ищет последний доступный дневной остаток, применяет к нему все операции до нужной даты и сохраняет результат как дневной остаток.

---

## Протоколирование операций

### Обязательность протоколирования
Все изменения количества предметов в инвентаре должны сопровождаться записью в протоколе операций.

### Атрибуты операции
- **Пользователь** - чей инвентарь изменяется
- **Раздел инвентаря** - в каком разделе происходит изменение (базовый, фабричный, торговый)
- **Предмет** - какой предмет затронут операцией
- **Коллекция** - коллекция предмета
- **Уровень качества** - уровень качества предмета
- **Изменение количества** - положительное (поступление) или отрицательное (расход) число
- **Тип операции** - категория операции (см. список ниже)
- **Идентификатор операции** - уникальный ID операции для связи с другими системами
- **Идентификатор рецепта** - ссылка на производственный рецепт (необязательное поле для контроля лимитов использования)
- **Комментарий** - дополнительная информация об операции
- **Время операции** - точное время выполнения операции

### Типы операций

#### Стандартные операции (базовый инвентарь)
- **chest_reward** - получение из сундука
- **craft_result** - результат производства (зачисление готовых предметов)
- **trade_sale** - продажа в торговле
- **trade_purchase** - покупка в торговле
- **admin_adjustment** - административная корректировка
- **system_reward** - системная награда
- **system_penalty** - системное списание

#### Операции фабричного инвентаря
- **factory_reservation** - резервирование материалов при создании производственного задания
- **factory_return** - возврат материалов при отмене задания
- **factory_consumption** - уничтожение материалов при успешном Claim

#### Операции торгового инвентаря (планируется)
- **trade_listing** - размещение предмета на продажу
- **trade_delisting** - снятие предмета с продажи

---

## Бизнес-правила

### Правила операций
1. **Запрет отрицательных остатков** - нельзя расходовать больше предметов, чем есть в инвентаре
2. **Атомарность операций** - операция либо выполняется полностью, либо не выполняется вообще
3. **Обязательное обоснование** - каждая операция должна иметь тип и идентификатор

### Правила предметов
1. **Уникальность в коллекции** - в рамках одной коллекции не может быть предметов с одинаковыми названиями
2. **Неизменность истории** - записи в протоколе операций не подлежат изменению или удалению

### Правила дневных остатков
1. **Фиксация в UTC** - все дневные остатки фиксируются по времени UTC
2. **Неизменность** - дневные остатки не подлежат изменению после создания
3. **Обязательность расчета** - при отсутствии дневного остатка он должен быть рассчитан и сохранен
