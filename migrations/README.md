# Database Migrations for Shard Legends: Clan Wars

## –ü—Ä–æ—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º **–ø—Ä–æ—Å—Ç—É—é –ª–∏–Ω–µ–π–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –º–∏–≥—Ä–∞—Ü–∏–π** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º–æ–π PostgreSQL:

- **–û–¥–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** –¥–ª—è –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤
- **–û—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ (auth, game, clan)
- **–ï–¥–∏–Ω—ã–π –Ω–∞–±–æ—Ä –º–∏–≥—Ä–∞—Ü–∏–π** –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
- **–ü—Ä–æ—Å—Ç–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–π

```
migrations/
‚îú‚îÄ‚îÄ Dockerfile                         # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
‚îú‚îÄ‚îÄ README.md                         # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ 000_init_schemas.up.sql           # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å—Ö–µ–º –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
‚îú‚îÄ‚îÄ 000_init_schemas.down.sql         # –û—Ç–∫–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ 001_create_users_table.up.sql     # Auth: —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îú‚îÄ‚îÄ 001_create_users_table.down.sql   # Auth: –æ—Ç–∫–∞—Ç —Ç–∞–±–ª–∏—Ü—ã
‚îú‚îÄ‚îÄ 002_create_game_profiles.up.sql   # Game: –∏–≥—Ä–æ–≤—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
‚îî‚îÄ‚îÄ 002_create_game_profiles.down.sql # Game: –æ—Ç–∫–∞—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
```

## –°–æ–≥–ª–∞—à–µ–Ω–∏—è –ø–æ –Ω—É–º–µ—Ä–∞—Ü–∏–∏

### 000-099: –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `000_*` - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π, –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- `001-099` - –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã, —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### 100-199: Auth Service
- `100_*` - –¢–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `101_*` - –ò–Ω–¥–µ–∫—Å—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 200-299: Game Service  
- `200_*` - –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
- `201_*` - Match-3 –¥–æ—Å–∫–∏ –∏ —Å–µ—Å—Å–∏–∏

### 300-399: Clan Service
- `300_*` - –ö–ª–∞–Ω—ã –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∏
- `301_*` - –ö–ª–∞–Ω–æ–≤—ã–µ –≤–æ–π–Ω—ã

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
docker-compose --profile migrations run --rm migrate up

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
docker-compose --profile migrations run --rm migrate version
```

### –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π
```bash
# –û—Ç–∫–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏
docker-compose --profile migrations run --rm migrate down 1

# –û—Ç–∫–∞—Ç –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏
docker-compose --profile migrations run --rm migrate goto 0

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ—Ä—Å–∏–∏ (–ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
docker-compose --profile migrations run --rm migrate force 1
```

### –†—É—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –ü—Ä—è–º–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ docker run
docker run --rm --network slcw-dev \
  -e DATABASE_URL="postgresql://slcw_user:dev_password_2024@slcw-postgres-dev:5432/shard_legends_dev?sslmode=disable" \
  -v $(pwd)/migrations:/migrations \
  dev-migrate:latest \
  up
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

### ‚úÖ –ü–ª—é—Å—ã:
1. **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ—Ç —Å–ª–æ–∂–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–∞–ø–æ–∫
2. **–ï–¥–∏–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫** - –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
3. **–ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤** - —á–µ—Ç–∫–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
4. **–õ–µ–≥–∫–æ –ø–æ–Ω—è—Ç—å** - –ª–∏–Ω–µ–π–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π
5. **–ü—Ä–æ—Å—Ç–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** - –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞

### üéØ –ü—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ—é —Å—Ö–µ–º—É** (`auth.*`, `game.*`, `clan.*`)
2. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–º–µ—Ä—É—é—Ç—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è** (000, 001, 002...)
3. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö** –º–∏–≥—Ä–∞—Ü–∏–π
4. **–û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏** (—Å—Ö–µ–º—ã, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)

## –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–º–µ—Ä
```bash
# –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä –º–∏–≥—Ä–∞—Ü–∏–∏
ls -1 migrations/*.up.sql | sort | tail -1
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 001_create_users_table.up.sql

# –°–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä: 002
```

### 2. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
# UP –º–∏–≥—Ä–∞—Ü–∏—è
touch migrations/002_add_user_preferences.up.sql
# DOWN –º–∏–≥—Ä–∞—Ü–∏—è  
touch migrations/002_add_user_preferences.down.sql
```

### 3. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
```sql
-- UP –º–∏–≥—Ä–∞—Ü–∏—è
-- Migration UP: 002_add_user_preferences.up.sql
-- Description: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
-- Service: auth-service
-- Depends: 001_create_users_table.up.sql

ALTER TABLE auth.users ADD COLUMN preferences JSONB DEFAULT '{}';
CREATE INDEX idx_users_preferences ON auth.users USING GIN (preferences);
```

```sql
-- DOWN –º–∏–≥—Ä–∞—Ü–∏—è
-- Migration DOWN: 002_add_user_preferences.down.sql
-- Description: –û—Ç–∫–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

DROP INDEX IF EXISTS auth.idx_users_preferences;
ALTER TABLE auth.users DROP COLUMN IF EXISTS preferences;
```

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –Ω–æ–º–µ—Ä–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π
**–†–µ—à–µ–Ω–∏–µ:** –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–π—Ç–µ—Å—å —Å –∫–æ–º–∞–Ω–¥–æ–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `migrate version` –∏ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏, –Ω–µ –∏–∑–º–µ–Ω—è–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞: –û—Ç–∫–∞—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ DOWN-–º–∏–≥—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ—Ç–∫–∞—Ç –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π UP-–º–∏–≥—Ä–∞—Ü–∏–∏

## –¢–µ–∫—É—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

- `000_init_schemas.*` - –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º auth, game, clan + PostgreSQL —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
- `001_create_users_table.*` - –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è auth-service

–°–ª–µ–¥—É—é—â–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ –º–µ—Ä–µ —Ä–∞–∑–≤–∏—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞.