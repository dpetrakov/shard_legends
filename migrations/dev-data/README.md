# Dev Data Migrations

Эта папка содержит SQL-скрипты для загрузки тестовых данных в базу данных для разработки и тестирования.

## ВАЖНО

⚠️ **Эти скрипты предназначены ТОЛЬКО для dev окружения!**

Они могут:
- Полностью очищать таблицы (TRUNCATE CASCADE)
- Загружать большие объемы тестовых данных
- Перезаписывать существующие данные

**НИКОГДА не запускайте эти скрипты в production окружении!**

## Структура

```
dev-data/
├── inventory-service/          # Тестовые данные для сервиса инвентаря
│   ├── 001_test_items_and_operations.sql   # Тестовые предметы и операции (удален)
│   ├── 002_reset_classifiers.sql           # Полная перезагрузка классификаторов
│   └── 003_reset_items.sql                  # Полная перезагрузка предметов (планируется)
├── production-service/         # Тестовые данные для сервиса производства
├── user-service/              # Тестовые данные для сервиса пользователей
└── auth-service/              # Тестовые данные для сервиса аутентификации
```

## Использование

### Запуск скриптов

```bash
# Из корня проекта
psql -h localhost -U slcw_user -d slcw_db -f migrations/dev-data/inventory-service/002_reset_classifiers.sql
```

### Порядок выполнения

Для inventory-service:
1. `002_reset_classifiers.sql` - загрузка классификаторов (справочников)
2. `003_reset_items.sql` - загрузка предметов (зависит от классификаторов)

## Скрипты

### inventory-service/002_reset_classifiers.sql

**Описание**: Полная перезагрузка всех классификаторов системы inventory

**Действия**:
1. Очищает таблицы `inventory.classifier_items` и `inventory.classifiers` (TRUNCATE CASCADE)
2. Загружает все классификаторы из `docs/specs/classifiers.md`
3. Загружает все элементы классификаторов с автоматической генерацией UUID
4. Проверяет количество загруженных записей

**Идемпотентность**: Да - повторный запуск приводит к тем же данным

**Зависимости**: Требует существования схемы inventory и таблиц классификаторов

### inventory-service/003_reset_items.sql

**Описание**: Полная перезагрузка предметов с мультиязычной поддержкой (i18n)

**Действия**:
1. Убирает временные поля name/description из таблицы items
2. Очищает таблицы предметов и переводов (inventory.items, i18n.translations)
3. Загружает предметы из `docs/specs/items-initial.md` без названий/описаний
4. Загружает переводы названий и описаний на русском и английском языках
5. Проверяет количество загруженных предметов и переводов

**Зависимости**: 002_reset_classifiers.sql, 008_create_i18n_schema.up.sql, 009_populate_languages.up.sql

**Идемпотентность**: Да - использует ON CONFLICT для обновления предметов и переводов

**Статистика загрузки**:
- Предметов: 29 (4 ресурса + 4 реагента + 3 ускорителя + 2 ключа + 10 сундуков + 4 чертежа + 4 инструмента)
- Переводов: ~116 (29 × 2 поля × 2 языка)

## Разработка новых скриптов

При создании новых dev-data скриптов:

1. **Начинайте с транзакции**: `BEGIN;` ... `COMMIT;`
2. **Очищайте данные**: Используйте `TRUNCATE ... CASCADE` для полной очистки
3. **Используйте gen_random_uuid()**: Для генерации UUID
4. **Проверяйте результат**: Добавьте блок DO $$ для проверки загруженных данных
5. **Документируйте**: Добавьте описание в этот README

## Примечания

- Все скрипты должны быть атомарными (в транзакции)
- Предпочитайте идемпотентные скрипты
- Используйте ON CONFLICT для обработки дубликатов
- Добавляйте комментарии в SQL для пояснения логики